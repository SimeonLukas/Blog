"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.renderPartialVideo = void 0;
exports.renderVideo = renderVideo;
const ffmpeg_1 = require("@revideo/ffmpeg");
const telemetry_1 = require("@revideo/telemetry");
const vite_plugin_1 = require("@revideo/vite-plugin");
const fs = require("fs");
const os = require("os");
const path = require("path");
const puppeteer_1 = require("puppeteer");
const vite_1 = require("vite");
const renderer_plugin_1 = require("./renderer-plugin");
const validate_settings_1 = require("./validate-settings");
/**
 * We pass a lot of render settings to the client side of the renderer
 * via the URL. This function builds the URL with the necessary parameters.
 */
function buildUrl(port, fileName, workerId, totalNumOfWorkers, hiddenFolderId) {
    const fileNameEscaped = encodeURIComponent(fileName);
    const hiddenFolderIdEscaped = encodeURIComponent(hiddenFolderId);
    return `http://localhost:${port}/render?fileName=${fileNameEscaped}&workerId=${workerId}&totalNumOfWorkers=${totalNumOfWorkers}&hiddenFolderId=${hiddenFolderIdEscaped}`;
}
/**
 * Starts the vite server and creates a puppeteer browser instance
 */
async function initBrowserAndServer(fixedPort, projectFile, outputFolderName, settings, variables) {
    const args = settings.puppeteer?.args ?? [];
    args.includes('--single-process') || args.push('--single-process');
    const resolvedProjectPath = path.join(process.cwd(), projectFile);
    const [browser, server] = await Promise.all([
        puppeteer_1.default.launch({ headless: true, ...settings.puppeteer, args }),
        (0, vite_1.createServer)({
            configFile: false,
            plugins: [
                (0, vite_plugin_1.default)({ project: resolvedProjectPath, output: outputFolderName }),
                (0, renderer_plugin_1.rendererPlugin)(settings.projectSettings, variables, settings.ffmpeg, projectFile),
            ],
            ...settings.viteConfig,
            server: {
                port: fixedPort,
                hmr: false,
                ...settings.viteServerOptions,
                ...settings.viteConfig?.server,
            },
        }).then(server => server.listen()),
    ]);
    if (!server.httpServer) {
        throw new Error('HTTP server is not initialized');
    }
    const address = server.httpServer.address();
    const resolvedPort = address && typeof address === 'object' ? address.port : null;
    if (resolvedPort === null) {
        throw new Error('Server address is null');
    }
    return { browser, server, resolvedPort };
}
function trackProgress(tracker, id, progress) {
    tracker.set(id, progress);
}
/**
 * Navigates to the URL and renders the video on the page
 */
async function renderVideoOnPage(id, browser, server, url, progressTracker, progressCallback, logProgress) {
    function printProgress() {
        let line = '';
        for (const [key, value] of progressTracker.entries()) {
            line += `Render progress, worker ${key}: ${(value * 100).toFixed(0)}% `;
        }
        if (line === '') {
            return;
        }
        console.log(line);
    }
    const interval = setInterval(() => {
        printProgress();
    }, 1000);
    const page = await browser.newPage();
    if (!server.httpServer) {
        throw new Error('HTTP server is not initialized');
    }
    const address = server.httpServer.address();
    const port = address && typeof address === 'object' ? address.port : null;
    if (port === null) {
        throw new Error('Server address is null');
    }
    // only report for worker 0
    if (id === 0) {
        (0, telemetry_1.sendEvent)(telemetry_1.EventName.RenderStarted);
    }
    // Attach logs from puppeteer to the console
    page.on('console', msg => {
        for (let i = 0; i < msg.args().length; ++i) {
            const message = msg.args()[i];
            if (message.toString().includes('[vite]')) {
                continue;
            }
            console.log(`Worker ${id}: ${msg.args()[i]}`);
        }
    });
    page.exposeFunction('logProgress', (progress) => {
        if (progressCallback) {
            progressCallback(id, progress);
        }
        if (logProgress) {
            trackProgress(progressTracker, id, progress);
        }
    });
    const renderingComplete = new Promise((resolve, reject) => {
        page.exposeFunction('onRenderComplete', async () => {
            await Promise.all([browser.close(), server.close()]);
            clearInterval(interval);
            resolve();
        });
        page.exposeFunction('onRenderFailed', async (errorMessage) => {
            await Promise.all([browser.close(), server.close()]);
            console.error('Rendering failed:', errorMessage);
            clearInterval(interval);
            reject(new Error(errorMessage));
        });
        page.exposeFunction('browserError', (message) => {
            reject(new Error(message));
        });
    });
    await page.goto(url);
    return renderingComplete;
}
/**
 * Initializes the browser and starts rendering the video
 */
async function initializeBrowserAndStartRendering(projectFile, outputFileName, outputFolderName, i, numOfWorkers, settings, hiddenFolderId, variables, progressCallback) {
    const port = (settings.viteBasePort !== undefined ? settings.viteBasePort : 9000) + i;
    const progressTracker = new Map();
    const { browser, server, resolvedPort } = await initBrowserAndServer(port, projectFile, outputFolderName, settings, variables);
    const url = buildUrl(resolvedPort, `${outputFileName}-${i}`, i, numOfWorkers, hiddenFolderId);
    return renderVideoOnPage(i, browser, server, url, progressTracker, progressCallback, settings.logProgress);
}
/**
 * Collects audio and video files from each worker and returns them.
 * If audio file does not exist, creates a silent audio file with the same duration as the video file.
 */
async function collectAudioAndVideoFiles(numOfWorkers, outputFileName, hiddenFolderId, format) {
    const audioFiles = [];
    const videoFiles = [];
    for (let i = 0; i < numOfWorkers; i++) {
        const videoFilePath = `${os.tmpdir()}/revideo-${outputFileName}-${i}-${hiddenFolderId}/visuals.${ffmpeg_1.extensions[format]}`;
        const audioFilePath = `${os.tmpdir()}/revideo-${outputFileName}-${i}-${hiddenFolderId}/audio.wav`;
        if (!(await (0, ffmpeg_1.doesFileExist)(audioFilePath))) {
            const videoDuration = await (0, ffmpeg_1.getVideoDuration)(videoFilePath);
            await (0, ffmpeg_1.createSilentAudioFile)(audioFilePath, videoDuration);
        }
        videoFiles.push(videoFilePath);
        audioFiles.push(audioFilePath);
    }
    return { audioFiles, videoFiles };
}
/**
 * Concatenates audio and video files and merges them into a single video file.
 */
async function concatenateAudioAndVideoFiles(outputFileName, outputFolder, audioFiles, videoFiles, format) {
    await (0, ffmpeg_1.concatenateMedia)(videoFiles, path.join(outputFolder, `${outputFileName}-visuals.${ffmpeg_1.extensions[format]}`));
    await (0, ffmpeg_1.concatenateMedia)(audioFiles, path.join(outputFolder, `${outputFileName}-audio.wav`));
    await (0, ffmpeg_1.mergeAudioWithVideo)(path.join(outputFolder, `${outputFileName}-audio.wav`), path.join(outputFolder, `${outputFileName}-visuals.${ffmpeg_1.extensions[format]}`), path.join(outputFolder, `${outputFileName}.${ffmpeg_1.extensions[format]}`), ffmpeg_1.audioCodecs[format]);
}
/**
 * Deletes all partial files after concatenation is done
 */
async function cleanup(outputFileName, outputFolderName, numOfWorkers, hiddenFolderId, format) {
    const cleanupFolders = [];
    const cleanupFiles = [];
    for (let i = 0; i < numOfWorkers; i++) {
        cleanupFolders.push(`${os.tmpdir()}/revideo-${outputFileName}-${i}-${hiddenFolderId}`);
        cleanupFiles.push(path.join(process.cwd(), outputFolderName, `${outputFileName}-${i}.${ffmpeg_1.extensions[format]}`));
    }
    cleanupFiles.push(path.join(process.cwd(), outputFolderName, `${outputFileName}-audio.wav`));
    cleanupFiles.push(path.join(process.cwd(), outputFolderName, `${outputFileName}-visuals.${ffmpeg_1.extensions[format]}`));
    const folderCleanupPromises = cleanupFolders.map(folder => fs.promises.rm(folder, { recursive: true, force: true }).catch(() => { }));
    const fileCleanupPromises = cleanupFiles.map(file => fs.promises.unlink(file).catch(() => { }));
    await Promise.all([...folderCleanupPromises, ...fileCleanupPromises]);
}
const defaultSettings = {
    projectSettings: {
        exporter: {
            name: '@revideo/core/wasm',
        },
    },
};
/**
 * Renders a video to a file.
 * @param projectFile - Path to the project.ts file.
 * @param variables - Variables to pass to your project (see https://docs.re.video/parameterized-video)
 * @param progressCallback - Callback function to track rendering progress. Progress is a number between 0 and 1.
 * @param settings - Settings for the rendering process.
 * @returns - Path to the rendered video file.
 */
async function renderVideo({ projectFile, variables, settings = defaultSettings, }) {
    const { outputFileName, outputFolderName, numOfWorkers, hiddenFolderId, format, } = (0, validate_settings_1.getParamDefaultsAndCheckValidity)(settings);
    // Start rendering
    const renderPromises = [];
    for (let i = 0; i < numOfWorkers; i++) {
        renderPromises.push(initializeBrowserAndStartRendering(projectFile, outputFileName, outputFolderName, i, numOfWorkers, settings, hiddenFolderId, variables, settings.progressCallback));
    }
    // Wait for workers to finish rendering
    await Promise.all(renderPromises);
    // Collect and concatenate audio and video files
    const { audioFiles, videoFiles } = await collectAudioAndVideoFiles(numOfWorkers, outputFileName, hiddenFolderId, format);
    await concatenateAudioAndVideoFiles(outputFileName, outputFolderName, audioFiles, videoFiles, format);
    await cleanup(outputFileName, outputFolderName, numOfWorkers, hiddenFolderId, format);
    return path.join(outputFolderName, `${outputFileName}.${ffmpeg_1.extensions[format]}`);
}
const renderPartialVideo = async ({ projectFile, variables, settings = defaultSettings, numWorkers, workerId, }) => {
    const { outputFileName, outputFolderName, hiddenFolderId, format } = (0, validate_settings_1.getParamDefaultsAndCheckValidity)(settings);
    await initializeBrowserAndStartRendering(projectFile, outputFileName, outputFolderName, workerId, numWorkers, settings, hiddenFolderId, variables, settings.progressCallback);
    const videoFilePath = `${os.tmpdir()}/revideo-${outputFileName}-${workerId}-${hiddenFolderId}/visuals.${ffmpeg_1.extensions[format]}`;
    const audioFilePath = `${os.tmpdir()}/revideo-${outputFileName}-${workerId}-${hiddenFolderId}/audio.wav`;
    if (!(await (0, ffmpeg_1.doesFileExist)(audioFilePath))) {
        const videoDuration = await (0, ffmpeg_1.getVideoDuration)(videoFilePath);
        await (0, ffmpeg_1.createSilentAudioFile)(audioFilePath, videoDuration);
    }
    return { audioFile: audioFilePath, videoFile: videoFilePath };
};
exports.renderPartialVideo = renderPartialVideo;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyLXZpZGVvLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc2VydmVyL3JlbmRlci12aWRlby50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUF1WUEsa0NBeURDO0FBM2JELDRDQVF5QjtBQUN6QixrREFBd0Q7QUFDeEQsc0RBQWdEO0FBQ2hELHlCQUF5QjtBQUN6Qix5QkFBeUI7QUFDekIsNkJBQTZCO0FBRTdCLHlDQUFrQztBQUVsQywrQkFBa0M7QUFDbEMsdURBQWlEO0FBQ2pELDJEQUFxRTtBQW1DckU7OztHQUdHO0FBQ0gsU0FBUyxRQUFRLENBQ2YsSUFBWSxFQUNaLFFBQWdCLEVBQ2hCLFFBQWdCLEVBQ2hCLGlCQUF5QixFQUN6QixjQUFzQjtJQUV0QixNQUFNLGVBQWUsR0FBRyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNyRCxNQUFNLHFCQUFxQixHQUFHLGtCQUFrQixDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBRWpFLE9BQU8sb0JBQW9CLElBQUksb0JBQW9CLGVBQWUsYUFBYSxRQUFRLHNCQUFzQixpQkFBaUIsbUJBQW1CLHFCQUFxQixFQUFFLENBQUM7QUFDM0ssQ0FBQztBQUVEOztHQUVHO0FBQ0gsS0FBSyxVQUFVLG9CQUFvQixDQUNqQyxTQUFpQixFQUNqQixXQUFtQixFQUNuQixnQkFBd0IsRUFDeEIsUUFBd0IsRUFDeEIsU0FBbUM7SUFFbkMsTUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDO0lBQzVDLElBQUksQ0FBQyxRQUFRLENBQUMsa0JBQWtCLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7SUFFbkUsTUFBTSxtQkFBbUIsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUNsRSxNQUFNLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQztRQUMxQyxtQkFBUyxDQUFDLE1BQU0sQ0FBQyxFQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUUsR0FBRyxRQUFRLENBQUMsU0FBUyxFQUFFLElBQUksRUFBQyxDQUFDO1FBQy9ELElBQUEsbUJBQVksRUFBQztZQUNYLFVBQVUsRUFBRSxLQUFLO1lBQ2pCLE9BQU8sRUFBRTtnQkFDUCxJQUFBLHFCQUFZLEVBQUMsRUFBQyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxFQUFFLGdCQUFnQixFQUFDLENBQUM7Z0JBQ3RFLElBQUEsZ0NBQWMsRUFDWixRQUFRLENBQUMsZUFBZSxFQUN4QixTQUFTLEVBQ1QsUUFBUSxDQUFDLE1BQU0sRUFDZixXQUFXLENBQ1o7YUFDRjtZQUNELEdBQUcsUUFBUSxDQUFDLFVBQVU7WUFDdEIsTUFBTSxFQUFFO2dCQUNOLElBQUksRUFBRSxTQUFTO2dCQUNmLEdBQUcsRUFBRSxLQUFLO2dCQUNWLEdBQUcsUUFBUSxDQUFDLGlCQUFpQjtnQkFDN0IsR0FBRyxRQUFRLENBQUMsVUFBVSxFQUFFLE1BQU07YUFDL0I7U0FDRixDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO0tBQ25DLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDdkIsTUFBTSxJQUFJLEtBQUssQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO0lBQ3BELENBQUM7SUFDRCxNQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQzVDLE1BQU0sWUFBWSxHQUNoQixPQUFPLElBQUksT0FBTyxPQUFPLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDL0QsSUFBSSxZQUFZLEtBQUssSUFBSSxFQUFFLENBQUM7UUFDMUIsTUFBTSxJQUFJLEtBQUssQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFFRCxPQUFPLEVBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUMsQ0FBQztBQUN6QyxDQUFDO0FBRUQsU0FBUyxhQUFhLENBQ3BCLE9BQTRCLEVBQzVCLEVBQVUsRUFDVixRQUFnQjtJQUVoQixPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxRQUFRLENBQUMsQ0FBQztBQUM1QixDQUFDO0FBRUQ7O0dBRUc7QUFDSCxLQUFLLFVBQVUsaUJBQWlCLENBQzlCLEVBQVUsRUFDVixPQUFnQixFQUNoQixNQUFxQixFQUNyQixHQUFXLEVBQ1gsZUFBb0MsRUFDcEMsZ0JBQTZELEVBQzdELFdBQXFCO0lBRXJCLFNBQVMsYUFBYTtRQUNwQixJQUFJLElBQUksR0FBRyxFQUFFLENBQUM7UUFDZCxLQUFLLE1BQU0sQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLElBQUksZUFBZSxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUM7WUFDckQsSUFBSSxJQUFJLDJCQUEyQixHQUFHLEtBQUssQ0FBQyxLQUFLLEdBQUcsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDMUUsQ0FBQztRQUVELElBQUksSUFBSSxLQUFLLEVBQUUsRUFBRSxDQUFDO1lBQ2hCLE9BQU87UUFDVCxDQUFDO1FBRUQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNwQixDQUFDO0lBRUQsTUFBTSxRQUFRLEdBQUcsV0FBVyxDQUFDLEdBQUcsRUFBRTtRQUNoQyxhQUFhLEVBQUUsQ0FBQztJQUNsQixDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFFVCxNQUFNLElBQUksR0FBRyxNQUFNLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNyQyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQ3ZCLE1BQU0sSUFBSSxLQUFLLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztJQUNwRCxDQUFDO0lBQ0QsTUFBTSxPQUFPLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUM1QyxNQUFNLElBQUksR0FBRyxPQUFPLElBQUksT0FBTyxPQUFPLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDMUUsSUFBSSxJQUFJLEtBQUssSUFBSSxFQUFFLENBQUM7UUFDbEIsTUFBTSxJQUFJLEtBQUssQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFFRCwyQkFBMkI7SUFDM0IsSUFBSSxFQUFFLEtBQUssQ0FBQyxFQUFFLENBQUM7UUFDYixJQUFBLHFCQUFTLEVBQUMscUJBQVMsQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUNyQyxDQUFDO0lBRUQsNENBQTRDO0lBQzVDLElBQUksQ0FBQyxFQUFFLENBQUMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxFQUFFO1FBQ3ZCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUM7WUFDM0MsTUFBTSxPQUFPLEdBQUcsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzlCLElBQUksT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDO2dCQUMxQyxTQUFTO1lBQ1gsQ0FBQztZQUVELE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLEtBQUssR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNoRCxDQUFDO0lBQ0gsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsY0FBYyxDQUFDLGFBQWEsRUFBRSxDQUFDLFFBQWdCLEVBQUUsRUFBRTtRQUN0RCxJQUFJLGdCQUFnQixFQUFFLENBQUM7WUFDckIsZ0JBQWdCLENBQUMsRUFBRSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ2pDLENBQUM7UUFDRCxJQUFJLFdBQVcsRUFBRSxDQUFDO1lBQ2hCLGFBQWEsQ0FBQyxlQUFlLEVBQUUsRUFBRSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQy9DLENBQUM7SUFDSCxDQUFDLENBQUMsQ0FBQztJQUVILE1BQU0saUJBQWlCLEdBQUcsSUFBSSxPQUFPLENBQU8sQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7UUFDOUQsSUFBSSxDQUFDLGNBQWMsQ0FBQyxrQkFBa0IsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNqRCxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEVBQUUsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztZQUNyRCxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDeEIsT0FBTyxFQUFFLENBQUM7UUFDWixDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxjQUFjLENBQUMsZ0JBQWdCLEVBQUUsS0FBSyxFQUFFLFlBQW9CLEVBQUUsRUFBRTtZQUNuRSxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEVBQUUsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztZQUNyRCxPQUFPLENBQUMsS0FBSyxDQUFDLG1CQUFtQixFQUFFLFlBQVksQ0FBQyxDQUFDO1lBQ2pELGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUN4QixNQUFNLENBQUMsSUFBSSxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztRQUNsQyxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxjQUFjLENBQUMsY0FBYyxFQUFFLENBQUMsT0FBZSxFQUFFLEVBQUU7WUFDdEQsTUFBTSxDQUFDLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFDN0IsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUVyQixPQUFPLGlCQUFpQixDQUFDO0FBQzNCLENBQUM7QUFFRDs7R0FFRztBQUNILEtBQUssVUFBVSxrQ0FBa0MsQ0FDL0MsV0FBbUIsRUFDbkIsY0FBc0IsRUFDdEIsZ0JBQXdCLEVBQ3hCLENBQVMsRUFDVCxZQUFvQixFQUNwQixRQUF3QixFQUN4QixjQUFzQixFQUN0QixTQUFtQyxFQUNuQyxnQkFBNkQ7SUFFN0QsTUFBTSxJQUFJLEdBQ1IsQ0FBQyxRQUFRLENBQUMsWUFBWSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBRTNFLE1BQU0sZUFBZSxHQUFHLElBQUksR0FBRyxFQUFrQixDQUFDO0lBRWxELE1BQU0sRUFBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBQyxHQUFHLE1BQU0sb0JBQW9CLENBQ2hFLElBQUksRUFDSixXQUFXLEVBQ1gsZ0JBQWdCLEVBQ2hCLFFBQVEsRUFDUixTQUFTLENBQ1YsQ0FBQztJQUVGLE1BQU0sR0FBRyxHQUFHLFFBQVEsQ0FDbEIsWUFBWSxFQUNaLEdBQUcsY0FBYyxJQUFJLENBQUMsRUFBRSxFQUN4QixDQUFDLEVBQ0QsWUFBWSxFQUNaLGNBQWMsQ0FDZixDQUFDO0lBRUYsT0FBTyxpQkFBaUIsQ0FDdEIsQ0FBQyxFQUNELE9BQU8sRUFDUCxNQUFNLEVBQ04sR0FBRyxFQUNILGVBQWUsRUFDZixnQkFBZ0IsRUFDaEIsUUFBUSxDQUFDLFdBQVcsQ0FDckIsQ0FBQztBQUNKLENBQUM7QUFFRDs7O0dBR0c7QUFDSCxLQUFLLFVBQVUseUJBQXlCLENBQ3RDLFlBQW9CLEVBQ3BCLGNBQXNCLEVBQ3RCLGNBQXNCLEVBQ3RCLE1BQXVDO0lBRXZDLE1BQU0sVUFBVSxHQUFHLEVBQUUsQ0FBQztJQUN0QixNQUFNLFVBQVUsR0FBRyxFQUFFLENBQUM7SUFDdEIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFlBQVksRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3RDLE1BQU0sYUFBYSxHQUFHLEdBQUcsRUFBRSxDQUFDLE1BQU0sRUFBRSxZQUFZLGNBQWMsSUFBSSxDQUFDLElBQUksY0FBYyxZQUFZLG1CQUFVLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztRQUN0SCxNQUFNLGFBQWEsR0FBRyxHQUFHLEVBQUUsQ0FBQyxNQUFNLEVBQUUsWUFBWSxjQUFjLElBQUksQ0FBQyxJQUFJLGNBQWMsWUFBWSxDQUFDO1FBRWxHLElBQUksQ0FBQyxDQUFDLE1BQU0sSUFBQSxzQkFBYSxFQUFDLGFBQWEsQ0FBQyxDQUFDLEVBQUUsQ0FBQztZQUMxQyxNQUFNLGFBQWEsR0FBRyxNQUFNLElBQUEseUJBQWdCLEVBQUMsYUFBYSxDQUFDLENBQUM7WUFDNUQsTUFBTSxJQUFBLDhCQUFxQixFQUFDLGFBQWEsRUFBRSxhQUFhLENBQUMsQ0FBQztRQUM1RCxDQUFDO1FBQ0QsVUFBVSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUMvQixVQUFVLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQ2pDLENBQUM7SUFFRCxPQUFPLEVBQUMsVUFBVSxFQUFFLFVBQVUsRUFBQyxDQUFDO0FBQ2xDLENBQUM7QUFFRDs7R0FFRztBQUNILEtBQUssVUFBVSw2QkFBNkIsQ0FDMUMsY0FBc0IsRUFDdEIsWUFBb0IsRUFDcEIsVUFBb0IsRUFDcEIsVUFBb0IsRUFDcEIsTUFBdUM7SUFFdkMsTUFBTSxJQUFBLHlCQUFnQixFQUNwQixVQUFVLEVBQ1YsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsR0FBRyxjQUFjLFlBQVksbUJBQVUsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQzNFLENBQUM7SUFDRixNQUFNLElBQUEseUJBQWdCLEVBQ3BCLFVBQVUsRUFDVixJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxHQUFHLGNBQWMsWUFBWSxDQUFDLENBQ3ZELENBQUM7SUFDRixNQUFNLElBQUEsNEJBQW1CLEVBQ3ZCLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLEdBQUcsY0FBYyxZQUFZLENBQUMsRUFDdEQsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsR0FBRyxjQUFjLFlBQVksbUJBQVUsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLEVBQzFFLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLEdBQUcsY0FBYyxJQUFJLG1CQUFVLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxFQUNsRSxvQkFBVyxDQUFDLE1BQU0sQ0FBQyxDQUNwQixDQUFDO0FBQ0osQ0FBQztBQUVEOztHQUVHO0FBQ0gsS0FBSyxVQUFVLE9BQU8sQ0FDcEIsY0FBc0IsRUFDdEIsZ0JBQXdCLEVBQ3hCLFlBQW9CLEVBQ3BCLGNBQXNCLEVBQ3RCLE1BQXVDO0lBRXZDLE1BQU0sY0FBYyxHQUFHLEVBQUUsQ0FBQztJQUMxQixNQUFNLFlBQVksR0FBRyxFQUFFLENBQUM7SUFDeEIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFlBQVksRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3RDLGNBQWMsQ0FBQyxJQUFJLENBQ2pCLEdBQUcsRUFBRSxDQUFDLE1BQU0sRUFBRSxZQUFZLGNBQWMsSUFBSSxDQUFDLElBQUksY0FBYyxFQUFFLENBQ2xFLENBQUM7UUFDRixZQUFZLENBQUMsSUFBSSxDQUNmLElBQUksQ0FBQyxJQUFJLENBQ1AsT0FBTyxDQUFDLEdBQUcsRUFBRSxFQUNiLGdCQUFnQixFQUNoQixHQUFHLGNBQWMsSUFBSSxDQUFDLElBQUksbUJBQVUsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUMvQyxDQUNGLENBQUM7SUFDSixDQUFDO0lBRUQsWUFBWSxDQUFDLElBQUksQ0FDZixJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsRUFBRSxnQkFBZ0IsRUFBRSxHQUFHLGNBQWMsWUFBWSxDQUFDLENBQzFFLENBQUM7SUFDRixZQUFZLENBQUMsSUFBSSxDQUNmLElBQUksQ0FBQyxJQUFJLENBQ1AsT0FBTyxDQUFDLEdBQUcsRUFBRSxFQUNiLGdCQUFnQixFQUNoQixHQUFHLGNBQWMsWUFBWSxtQkFBVSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQ2xELENBQ0YsQ0FBQztJQUVGLE1BQU0scUJBQXFCLEdBQUcsY0FBYyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUN4RCxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsRUFBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsR0FBRSxDQUFDLENBQUMsQ0FDdkUsQ0FBQztJQUVGLE1BQU0sbUJBQW1CLEdBQUcsWUFBWSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUNsRCxFQUFFLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLEdBQUUsQ0FBQyxDQUFDLENBQ3pDLENBQUM7SUFFRixNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLHFCQUFxQixFQUFFLEdBQUcsbUJBQW1CLENBQUMsQ0FBQyxDQUFDO0FBQ3hFLENBQUM7QUFFRCxNQUFNLGVBQWUsR0FBbUI7SUFDdEMsZUFBZSxFQUFFO1FBQ2YsUUFBUSxFQUFFO1lBQ1IsSUFBSSxFQUFFLG9CQUFvQjtTQUMzQjtLQUNGO0NBQ0YsQ0FBQztBQVFGOzs7Ozs7O0dBT0c7QUFDSSxLQUFLLFVBQVUsV0FBVyxDQUFDLEVBQ2hDLFdBQVcsRUFDWCxTQUFTLEVBQ1QsUUFBUSxHQUFHLGVBQWUsR0FDUjtJQUNsQixNQUFNLEVBQ0osY0FBYyxFQUNkLGdCQUFnQixFQUNoQixZQUFZLEVBQ1osY0FBYyxFQUNkLE1BQU0sR0FDUCxHQUFHLElBQUEsb0RBQWdDLEVBQUMsUUFBUSxDQUFDLENBQUM7SUFFL0Msa0JBQWtCO0lBQ2xCLE1BQU0sY0FBYyxHQUFHLEVBQUUsQ0FBQztJQUMxQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsWUFBWSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7UUFDdEMsY0FBYyxDQUFDLElBQUksQ0FDakIsa0NBQWtDLENBQ2hDLFdBQVcsRUFDWCxjQUFjLEVBQ2QsZ0JBQWdCLEVBQ2hCLENBQUMsRUFDRCxZQUFZLEVBQ1osUUFBUSxFQUNSLGNBQWMsRUFDZCxTQUFTLEVBQ1QsUUFBUSxDQUFDLGdCQUFnQixDQUMxQixDQUNGLENBQUM7SUFDSixDQUFDO0lBRUQsdUNBQXVDO0lBQ3ZDLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUVsQyxnREFBZ0Q7SUFDaEQsTUFBTSxFQUFDLFVBQVUsRUFBRSxVQUFVLEVBQUMsR0FBRyxNQUFNLHlCQUF5QixDQUM5RCxZQUFZLEVBQ1osY0FBYyxFQUNkLGNBQWMsRUFDZCxNQUFNLENBQ1AsQ0FBQztJQUNGLE1BQU0sNkJBQTZCLENBQ2pDLGNBQWMsRUFDZCxnQkFBZ0IsRUFDaEIsVUFBVSxFQUNWLFVBQVUsRUFDVixNQUFNLENBQ1AsQ0FBQztJQUNGLE1BQU0sT0FBTyxDQUNYLGNBQWMsRUFDZCxnQkFBZ0IsRUFDaEIsWUFBWSxFQUNaLGNBQWMsRUFDZCxNQUFNLENBQ1AsQ0FBQztJQUVGLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLGNBQWMsSUFBSSxtQkFBVSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUNoRixDQUFDO0FBUU0sTUFBTSxrQkFBa0IsR0FBRyxLQUFLLEVBQUUsRUFDdkMsV0FBVyxFQUNYLFNBQVMsRUFDVCxRQUFRLEdBQUcsZUFBZSxFQUMxQixVQUFVLEVBQ1YsUUFBUSxHQUNnQixFQUFFLEVBQUU7SUFDNUIsTUFBTSxFQUFDLGNBQWMsRUFBRSxnQkFBZ0IsRUFBRSxjQUFjLEVBQUUsTUFBTSxFQUFDLEdBQzlELElBQUEsb0RBQWdDLEVBQUMsUUFBUSxDQUFDLENBQUM7SUFFN0MsTUFBTSxrQ0FBa0MsQ0FDdEMsV0FBVyxFQUNYLGNBQWMsRUFDZCxnQkFBZ0IsRUFDaEIsUUFBUSxFQUNSLFVBQVUsRUFDVixRQUFRLEVBQ1IsY0FBYyxFQUNkLFNBQVMsRUFDVCxRQUFRLENBQUMsZ0JBQWdCLENBQzFCLENBQUM7SUFFRixNQUFNLGFBQWEsR0FBRyxHQUFHLEVBQUUsQ0FBQyxNQUFNLEVBQUUsWUFBWSxjQUFjLElBQUksUUFBUSxJQUFJLGNBQWMsWUFBWSxtQkFBVSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7SUFDN0gsTUFBTSxhQUFhLEdBQUcsR0FBRyxFQUFFLENBQUMsTUFBTSxFQUFFLFlBQVksY0FBYyxJQUFJLFFBQVEsSUFBSSxjQUFjLFlBQVksQ0FBQztJQUV6RyxJQUFJLENBQUMsQ0FBQyxNQUFNLElBQUEsc0JBQWEsRUFBQyxhQUFhLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDMUMsTUFBTSxhQUFhLEdBQUcsTUFBTSxJQUFBLHlCQUFnQixFQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQzVELE1BQU0sSUFBQSw4QkFBcUIsRUFBQyxhQUFhLEVBQUUsYUFBYSxDQUFDLENBQUM7SUFDNUQsQ0FBQztJQUVELE9BQU8sRUFBQyxTQUFTLEVBQUUsYUFBYSxFQUFFLFNBQVMsRUFBRSxhQUFhLEVBQUMsQ0FBQztBQUM5RCxDQUFDLENBQUM7QUEvQlcsUUFBQSxrQkFBa0Isc0JBK0I3QiJ9