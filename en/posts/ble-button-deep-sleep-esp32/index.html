<!DOCTYPE html>
<html lang="de">
<html class="dark light">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    

    
    
    
    <title>
         BLE Button with Deep Sleep: When an ESP32-S3 Becomes a Photo Trigger
        
    </title>

    
    
    <meta name="description" content="A power-efficient Bluetooth button for the tourism wheel of fortune - with Deep Sleep, Bonding, and months of battery life. From failures, debugging sessions..." />
    
    

    
    <meta property="og:image" content="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32//images/en/preview.jpg" />
    <meta property="og:logo" content="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32//imagesen/preview.jpg" />
    <!-- twitter card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/images/en/preview.jpg">
    

    
    <meta property="og:title" content="BLE Button with Deep Sleep: When an ESP32-S3 Becomes a Photo Trigger" />
    <!-- twitter title -->
    <meta name="twitter:title" content="BLE Button with Deep Sleep: When an ESP32-S3 Becomes a Photo Trigger">
    
    

    
    
    <meta property="og:description" content="A power-efficient Bluetooth button for the tourism wheel of fortune - with Deep Sleep, Bonding, and months of battery life. From failures, debugging sessions..."/>
    <!-- twitter description -->
    <meta name="twitter:description" content="A power-efficient Bluetooth button for the tourism wheel of fortune - with Deep Sleep, Bonding, and months of battery life. From failures, debugging sessions...">
    
    

    <meta property="og:url" content="https:&#x2F;&#x2F;simeon.staneks.de"/>
    <meta property="og:type" content="article" />

    <meta name="keywords"
    content="Webdesign, Website, Benutzerfreundlichkeit, Responsive Design, Oberammergau, HTML, CSS, UX, UI, Grafikdesign, Typografie, Farbschema, Barrierefreiheit, SEO, Suchmaschinenoptimierung, Content-Strategie, Interaktionsdesign, Wireframes, Prototyping, Navigation, Mobile First, Usability-Tests, SSG, Garmisch-Partenkirchen, App">
    <meta name="author" content="Simeon Stanek" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="msapplication-TileColor" content="#00a300">
    <meta name="theme-color" content="#ffffff">
    <meta property="og:site_name" content="Blog by Simeon" />


    
    
    <link rel="icon" type="image/png" href=https:&#x2F;&#x2F;simeon.staneks.de&#x2F;android-chrome-512x512.png />
    

    
    
    <link href=https://simeon.staneks.de/fonts.css rel="stylesheet" />
    

    
    

    
    
    <script src=https://simeon.staneks.de/js/codeblock.js></script>
    

    
    
    <script src=https://simeon.staneks.de/js/toc.js></script>
    

    
    
    <script src=https://simeon.staneks.de/js/note.js></script>
    
    

    
    <link rel="alternate" type="application/atom+xml" title="Blog by Simeon" href="https://simeon.staneks.de/ atom.xml">


    
    
    <link rel="stylesheet" type="text/css" href=https://simeon.staneks.de/theme/light.css />
    <link id="darkModeStyle" rel="stylesheet" type="text/css" href="https://simeon.staneks.de/theme/dark.css" />
    

    <!-- Set the correct theme in the script -->
    <script src=https://simeon.staneks.de/js/themetoggle.js></script>
    
    <script>setTheme(getSavedTheme());</script>
    
    <script src=https://simeon.staneks.de/js/index.js></script>
    <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
  </script>

    <link rel="stylesheet" type="text/css" media="screen" href=https://simeon.staneks.de/main.css />

    
</head>

<body onload="updatelanguage()">
    <div class="content">
        <header>
    <div class="main">
        <div> <a id="navigation_start" href=https:&#x2F;&#x2F;simeon.staneks.de>Blog by Simeon </a> 
            <p style="font-size: xx-small;">It&#x27;s better to start imperfectly than wait perfectly</p> 
        </div>
        <div class="socials">
            
            <a rel="me" href="https:&#x2F;&#x2F;indieweb.social&#x2F;@simerl" class="social mastodon">
                <img alt=mastodon src=https://simeon.staneks.de/social_icons/mastodon.svg>
            </a>
            
            <a rel="me" href="https:&#x2F;&#x2F;www.instagram.com&#x2F;simeonstanek&#x2F;" class="social instagram">
                <img alt=instagram src=https://simeon.staneks.de/social_icons/instagram.svg>
            </a>
            
            <a rel="me" href="https:&#x2F;&#x2F;github.com&#x2F;SimeonLukas" class="social github">
                <img alt=github src=https://simeon.staneks.de/social_icons/github.svg>
            </a>
            
            <a rel="me" href="https:&#x2F;&#x2F;buymeacoffee.com&#x2F;simeonlukas" class="social buy me a coffee">
                <img alt=buy me a coffee src=https://simeon.staneks.de/social_icons/bmc-logo.svg>
            </a>
            
            <a rel="me" href="&#x2F;rss.xml" class="social rss">
                <img alt=rss src=https://simeon.staneks.de/social_icons/rss.svg>
            </a>
            
        </div>
    </div>

    <nav>
        
        <a class="navigation_lang &#x2F;posts" href=&#x2F;posts style="margin-left: 0.5em">&#x2F;posts</a>
        
        <a class="navigation_lang &#x2F;pages" href=&#x2F;pages style="margin-left: 0.5em">&#x2F;pages</a>
        
        <a class="navigation_lang &#x2F;about" href=&#x2F;pages&#x2F;about style="margin-left: 0.5em">&#x2F;about</a>
        
        <a class="navigation_lang &#x2F;tags" href=&#x2F;tags style="margin-left: 0.5em">&#x2F;tags</a>
        

        
        |<a id="dark-mode-toggle" onclick="toggleTheme(); event.preventDefault();" href="#">
            <img src=https://simeon.staneks.de/feather/sun.svg id="sun-icon" style="filter: invert(1);" alt="Light" />
            <img src=https://simeon.staneks.de/feather/moon.svg id="moon-icon" alt="Dark" />
        </a>

        <!-- Inititialize the theme toggle icons -->
        <script>updateItemToggleTheme()</script>
        
        <a id="language-toggle" onclick="toggleLanguage(); event.preventDefault();" href="#">
            <img src=https://simeon.staneks.de/feather/globe.svg alt="Change Language" /><span style="font-size: xx-small;" id="language-name">de</span>
        </a>
    </nav>
</header>


        
        
    
<main>
    <article>
        <div class="title">
            
            
    <h1 class="page-header">
        BLE Button with Deep Sleep: When an ESP32-S3 Becomes a Photo Trigger<span class="primary-color" style="font-size: 1.6em">.</span>
    </h1>

        </div>
        A power-efficient Bluetooth button for the tourism wheel of fortune - with Deep Sleep, Bonding, and months of battery life. From failures, debugging sessions, and the final breakthrough.

        

        
        
        
            <div class="toc-container">
                <h1 class="toc-title">Table of Contents</h1>
                <ul class="toc-list">
                    
                        <li>
                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#the-starting-point-a-wheel-of-fortune-needs-a-button">The Starting Point: A Wheel of Fortune Needs a Button</a>
                            
                        </li>
                    
                        <li>
                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#the-concept-three-requirements">The Concept: Three Requirements</a>
                            
                        </li>
                    
                        <li>
                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#hardware-keep-it-simple">Hardware - Keep it simple!</a>
                            
                        </li>
                    
                        <li>
                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#the-challenges-a-rocky-road-to-success">The Challenges: A Rocky Road to Success</a>
                            
                                <ul>
                                    
                                        <li>
                                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#problem-1-esp-wouldn-t-enter-deep-sleep">Problem #1: ESP Wouldn&#x27;t Enter Deep Sleep</a>
                                        </li>

                                        
                                    
                                        <li>
                                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#problem-2-esp-woke-up-immediately">Problem #2: ESP Woke Up Immediately</a>
                                        </li>

                                        
                                    
                                        <li>
                                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#problem-3-rtc-gpio-configuration">Problem #3: RTC GPIO Configuration</a>
                                        </li>

                                        
                                    
                                        <li>
                                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#problem-4-2-wasn-t-being-sent">Problem #4: &quot;2&quot; Wasn&#x27;t Being Sent</a>
                                        </li>

                                        
                                    
                                        <li>
                                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#problem-5-connection-kept-dropping">Problem #5: Connection Kept Dropping</a>
                                        </li>

                                        
                                    
                                </ul>
                            
                        </li>
                    
                        <li>
                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#the-code-compact-and-well-thought-out">The Code: Compact and Well-Thought-Out</a>
                            
                        </li>
                    
                        <li>
                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#how-it-works-the-flow">How It Works: The Flow</a>
                            
                        </li>
                    
                        <li>
                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#power-supply-with-cr123a-battery">Power Supply with CR123A Battery</a>
                            
                                <ul>
                                    
                                        <li>
                                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#why-cr123a">Why CR123A?</a>
                                        </li>

                                        
                                    
                                        <li>
                                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#connection">Connection</a>
                                        </li>

                                        
                                    
                                </ul>
                            
                        </li>
                    
                        <li>
                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#power-consumption-the-numbers">Power Consumption: The Numbers</a>
                            
                        </li>
                    
                        <li>
                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#the-most-important-insights">The Most Important Insights</a>
                            
                                <ul>
                                    
                                        <li>
                                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#1-esp32-s3-is-different">1. ESP32-S3 is Different</a>
                                        </li>

                                        
                                    
                                        <li>
                                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#2-deep-sleep-is-picky">2. Deep Sleep is Picky</a>
                                        </li>

                                        
                                    
                                        <li>
                                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#3-ble-takes-time">3. BLE Takes Time</a>
                                        </li>

                                        
                                    
                                        <li>
                                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#4-bonding-is-worth-gold">4. Bonding is Worth Gold</a>
                                        </li>

                                        
                                    
                                        <li>
                                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#5-fixed-mac-happy-life">5. Fixed MAC = Happy Life</a>
                                        </li>

                                        
                                    
                                </ul>
                            
                        </li>
                    
                        <li>
                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#why-you-should-try-it-yourself">Why You Should Try It Yourself</a>
                            
                        </li>
                    
                        <li>
                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#use-at-the-wheel-of-fortune">Use at the Wheel of Fortune</a>
                            
                        </li>
                    
                        <li>
                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#outlook-what-else-would-be-possible">Outlook: What Else Would Be Possible</a>
                            
                        </li>
                    
                        <li>
                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#let-s-go">Let&#x27;s Go!</a>
                            
                        </li>
                    
                        <li>
                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#shopping-list-everything-you-need">Shopping List - Everything You Need</a>
                            
                                <ul>
                                    
                                        <li>
                                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#main-components">Main Components</a>
                                        </li>

                                        
                                    
                                        <li>
                                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#power-supply">Power Supply</a>
                                        </li>

                                        
                                    
                                        <li>
                                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#optional-but-useful">Optional but Useful</a>
                                        </li>

                                        
                                    
                                        <li>
                                            <a href="https://simeon.staneks.de/en/posts/ble-button-deep-sleep-esp32/#estimated-total-cost">Estimated Total Cost</a>
                                        </li>

                                        
                                    
                                </ul>
                            
                        </li>
                    
                </ul>
            </div>
        
        

        <section class="body">
            <h2 id="the-starting-point-a-wheel-of-fortune-needs-a-button"><a class="zola-anchor" href="#the-starting-point-a-wheel-of-fortune-needs-a-button" aria-label="Anchor link for: the-starting-point-a-wheel-of-fortune-needs-a-button">The Starting Point: A Wheel of Fortune Needs a Button</a></h2>
<p>A while ago, I developed a <a href="https://simeon.staneks.de/posts/20241120/">digital wheel of fortune</a> for tourism ministry. At events, people press a red USB-connected button to spin the wheel. And when they land on the right field, a photo should be taken - for memories, the guestbook, for Instagram. But not every field triggers a photo. That's why I needed a simple way to activate the photo trigger.</p>
<p>The idea: A wireless button that visitors can press to trigger the photo. Simple, right?</p>
<p><strong>Spoiler</strong>: It wasn't. But in the end it works - and how! üéâ</p>
<h2 id="the-concept-three-requirements"><a class="zola-anchor" href="#the-concept-three-requirements" aria-label="Anchor link for: the-concept-three-requirements">The Concept: Three Requirements</a></h2>
<p>I had clear ideas about what the button should be able to do:</p>
<ol>
<li><strong>Battery-powered</strong>: No cables at events, please!</li>
<li><strong>Reliable</strong>: When pressed, it should send the key "2" (which triggers the photo function in my setup)</li>
<li><strong>Long battery life</strong>: I don't want to constantly change batteries</li>
</ol>
<p>The solution: An <strong>ESP32-S3</strong> with <strong>BLE</strong> (Bluetooth Low Energy) that acts as a keyboard and waits for button presses in <strong>Deep Sleep</strong>.</p>
<h2 id="hardware-keep-it-simple"><a class="zola-anchor" href="#hardware-keep-it-simple" aria-label="Anchor link for: hardware-keep-it-simple">Hardware - Keep it simple!</a></h2>
<p>For this project you really don't need much:</p>
<ul>
<li>ESP32-S3 Dev Module (~$5-10)</li>
<li>A push button (e.g., 100mm arcade button)</li>
<li>CR123A battery + battery holder (see shopping list below)</li>
<li>Optional: An enclosure (3D print, project box, ashtray from discount store, etc.)</li>
</ul>
<p><strong>The setup:</strong></p>
<ul>
<li>Button connected to GPIO5 and GND</li>
<li>Use internal pullup resistors (no external electronics needed!)</li>
<li>When button is pressed: Pin goes LOW ‚Üí ESP wakes up</li>
</ul>
<pre style="background-color:#fafafa;color:#61676c;"><code><span>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
</span><span>‚îÇ   ESP32-S3  ‚îÇ
</span><span>‚îÇ             ‚îÇ
</span><span>‚îÇ  GPIO5 ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ Button ‚îÄ‚îÄ‚îÄ‚îÄ GND
</span><span>‚îÇ             ‚îÇ
</span><span>‚îÇ  (Pullup    ‚îÇ
</span><span>‚îÇ   internal) ‚îÇ
</span><span>‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</span></code></pre>
<h2 id="the-challenges-a-rocky-road-to-success"><a class="zola-anchor" href="#the-challenges-a-rocky-road-to-success" aria-label="Anchor link for: the-challenges-a-rocky-road-to-success">The Challenges: A Rocky Road to Success</a></h2>
<h3 id="problem-1-esp-wouldn-t-enter-deep-sleep"><a class="zola-anchor" href="#problem-1-esp-wouldn-t-enter-deep-sleep" aria-label="Anchor link for: problem-1-esp-wouldn-t-enter-deep-sleep">Problem #1: ESP Wouldn't Enter Deep Sleep</a></h3>
<p><strong>Symptom</strong>: The ESP simply didn't want to sleep. Power consumption remained high, battery monitor showed 80-120mA instead of the expected ~10¬µA.</p>
<p><strong>Diagnosis</strong>: On the ESP32-S3, the active USB-Serial connection prevents Deep Sleep! Additionally, BLE wasn't completely disabled.</p>
<p><strong>Solution</strong>:</p>
<pre data-lang="cpp" style="background-color:#fafafa;color:#61676c;" class="language-cpp "><code class="language-cpp" data-lang="cpp"><span>Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">end</span><span>()</span><span style="color:#61676ccc;">;        </span><span style="font-style:italic;color:#abb0b6;">// End Serial
</span><span>USBSerial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">end</span><span>()</span><span style="color:#61676ccc;">;     </span><span style="font-style:italic;color:#abb0b6;">// ESP32-S3 specific!
</span><span style="color:#f29718;">btStop</span><span>()</span><span style="color:#61676ccc;">;            </span><span style="font-style:italic;color:#abb0b6;">// Stop Bluetooth completely
</span><span style="color:#f29718;">esp_deep_sleep_start</span><span>()</span><span style="color:#61676ccc;">;
</span></code></pre>
<h3 id="problem-2-esp-woke-up-immediately"><a class="zola-anchor" href="#problem-2-esp-woke-up-immediately" aria-label="Anchor link for: problem-2-esp-woke-up-immediately">Problem #2: ESP Woke Up Immediately</a></h3>
<p>This was frustrating: The ESP went to sleep... and 300ms later it was awake again. Endless loop!</p>
<p><strong>Cause</strong>: The button pin was still LOW (pressed) when going to sleep. The ext0 wakeup triggered immediately because the condition "wake up on LOW" was already met.</p>
<p><strong>Solution</strong>: Wait until the button is released!</p>
<pre data-lang="cpp" style="background-color:#fafafa;color:#61676c;" class="language-cpp "><code class="language-cpp" data-lang="cpp"><span style="color:#fa6e32;">while</span><span>(</span><span style="color:#f29718;">digitalRead</span><span>(buttonPin) </span><span style="color:#ed9366;">==</span><span> LOW) {
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;Button pressed - waiting...&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  </span><span style="color:#f29718;">delay</span><span>(</span><span style="color:#ff8f40;">100</span><span>)</span><span style="color:#61676ccc;">;
</span><span>}
</span><span style="color:#f29718;">delay</span><span>(</span><span style="color:#ff8f40;">500</span><span>)</span><span style="color:#61676ccc;">;  </span><span style="font-style:italic;color:#abb0b6;">// Safety buffer
</span></code></pre>
<h3 id="problem-3-rtc-gpio-configuration"><a class="zola-anchor" href="#problem-3-rtc-gpio-configuration" aria-label="Anchor link for: problem-3-rtc-gpio-configuration">Problem #3: RTC GPIO Configuration</a></h3>
<p>The ESP32-S3 has a peculiarity: For ext0 wakeup you must explicitly configure the <strong>RTC GPIO</strong>. Without it, the wakeup doesn't work reliably.</p>
<pre data-lang="cpp" style="background-color:#fafafa;color:#61676c;" class="language-cpp "><code class="language-cpp" data-lang="cpp"><span style="color:#f29718;">rtc_gpio_init</span><span>((gpio_num_t)buttonPin)</span><span style="color:#61676ccc;">;
</span><span style="color:#f29718;">rtc_gpio_set_direction</span><span>((gpio_num_t)buttonPin</span><span style="color:#61676ccc;">,</span><span> RTC_GPIO_MODE_INPUT_ONLY)</span><span style="color:#61676ccc;">;
</span><span style="color:#f29718;">rtc_gpio_pullup_en</span><span>((gpio_num_t)buttonPin)</span><span style="color:#61676ccc;">;
</span><span style="color:#f29718;">rtc_gpio_hold_en</span><span>((gpio_num_t)buttonPin)</span><span style="color:#61676ccc;">;  </span><span style="font-style:italic;color:#abb0b6;">// Hold config during sleep!
</span></code></pre>
<p>The <code>rtc_gpio_hold_en()</code> is crucial - it ensures that the pin configuration is maintained during Deep Sleep.</p>
<h3 id="problem-4-2-wasn-t-being-sent"><a class="zola-anchor" href="#problem-4-2-wasn-t-being-sent" aria-label="Anchor link for: problem-4-2-wasn-t-being-sent">Problem #4: "2" Wasn't Being Sent</a></h3>
<p>The ESP woke up, BLE started... but no key was sent. Then the timeout came and it went back to sleep.</p>
<p><strong>Cause</strong>: BLE needs 5-10 seconds to connect! But the original 10-second timer was already running when waking up.</p>
<p><strong>Solution</strong>: Timer is reset <strong>after</strong> successful sending:</p>
<pre data-lang="cpp" style="background-color:#fafafa;color:#61676c;" class="language-cpp "><code class="language-cpp" data-lang="cpp"><span style="color:#fa6e32;">if</span><span>(bleKeyboard</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">isConnected</span><span>()) {
</span><span>  bleKeyboard</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">print</span><span>(</span><span style="color:#86b300;">&quot;2&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  startTime </span><span style="color:#ed9366;">= </span><span style="color:#f29718;">millis</span><span>()</span><span style="color:#61676ccc;">;  </span><span style="font-style:italic;color:#abb0b6;">// NOW restart timer!
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;Timer restarted - 10 seconds awake&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>}
</span></code></pre>
<h3 id="problem-5-connection-kept-dropping"><a class="zola-anchor" href="#problem-5-connection-kept-dropping" aria-label="Anchor link for: problem-5-connection-kept-dropping">Problem #5: Connection Kept Dropping</a></h3>
<p>After every Deep Sleep, the device had to be paired again. Annoying!</p>
<p><strong>Cause</strong>: No bonding information was being stored. The computer saw a "new" device after every wake-up.</p>
<p><strong>Solution</strong>: Activate BLE Security with Bonding:</p>
<pre data-lang="cpp" style="background-color:#fafafa;color:#61676c;" class="language-cpp "><code class="language-cpp" data-lang="cpp"><span>esp_ble_auth_req_t auth_req </span><span style="color:#ed9366;">=</span><span> ESP_LE_AUTH_REQ_SC_MITM_BOND</span><span style="color:#61676ccc;">;
</span><span style="color:#f29718;">esp_ble_gap_set_security_param</span><span>(ESP_BLE_SM_AUTHEN_REQ_MODE</span><span style="color:#61676ccc;">, </span><span style="color:#ed9366;">&amp;</span><span>auth_req</span><span style="color:#61676ccc;">, </span><span style="color:#fa6e32;">sizeof</span><span>(</span><span style="font-style:italic;color:#55b4d4;">uint8_t</span><span>))</span><span style="color:#61676ccc;">;
</span><span style="font-style:italic;color:#abb0b6;">// ... more security parameters
</span></code></pre>
<p>And store a <strong>fixed MAC address</strong> in flash:</p>
<pre data-lang="cpp" style="background-color:#fafafa;color:#61676c;" class="language-cpp "><code class="language-cpp" data-lang="cpp"><span style="color:#fa6e32;">void </span><span style="color:#f29718;">setCustomMacAddress</span><span>() {
</span><span>  preferences</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">begin</span><span>(</span><span style="color:#86b300;">&quot;ble-button&quot;</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">false</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  </span><span style="color:#fa6e32;">if </span><span>(</span><span style="color:#ed9366;">!</span><span>preferences</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">getBool</span><span>(</span><span style="color:#86b300;">&quot;mac_set&quot;</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">false</span><span>)) {
</span><span>    </span><span style="font-style:italic;color:#abb0b6;">// On first start: Generate random MAC
</span><span>    </span><span style="font-style:italic;color:#55b4d4;">uint8_t</span><span> newMac[</span><span style="color:#ff8f40;">6</span><span>]</span><span style="color:#61676ccc;">;
</span><span>    </span><span style="color:#f29718;">esp_fill_random</span><span>(newMac</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">6</span><span>)</span><span style="color:#61676ccc;">;
</span><span>    newMac[</span><span style="color:#ff8f40;">0</span><span>] </span><span style="color:#ed9366;">= </span><span>(newMac[</span><span style="color:#ff8f40;">0</span><span>] </span><span style="color:#ed9366;">&amp; </span><span style="color:#ff8f40;">0xFE</span><span>) </span><span style="color:#ed9366;">| </span><span style="color:#ff8f40;">0x02</span><span style="color:#61676ccc;">;  </span><span style="font-style:italic;color:#abb0b6;">// Locally administered
</span><span>    preferences</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">putBytes</span><span>(</span><span style="color:#86b300;">&quot;mac_addr&quot;</span><span style="color:#61676ccc;">,</span><span> newMac</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">6</span><span>)</span><span style="color:#61676ccc;">;
</span><span>    preferences</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">putBool</span><span>(</span><span style="color:#86b300;">&quot;mac_set&quot;</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">true</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  }
</span><span>  
</span><span>  </span><span style="font-style:italic;color:#55b4d4;">uint8_t</span><span> customMac[</span><span style="color:#ff8f40;">6</span><span>]</span><span style="color:#61676ccc;">;
</span><span>  preferences</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">getBytes</span><span>(</span><span style="color:#86b300;">&quot;mac_addr&quot;</span><span style="color:#61676ccc;">,</span><span> customMac</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">6</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  </span><span style="color:#f29718;">esp_base_mac_addr_set</span><span>(customMac)</span><span style="color:#61676ccc;">;
</span><span>}
</span></code></pre>
<h2 id="the-code-compact-and-well-thought-out"><a class="zola-anchor" href="#the-code-compact-and-well-thought-out" aria-label="Anchor link for: the-code-compact-and-well-thought-out">The Code: Compact and Well-Thought-Out</a></h2>
<p>Here's the final, working code:</p>
<pre data-lang="cpp" style="background-color:#fafafa;color:#61676c;" class="language-cpp "><code class="language-cpp" data-lang="cpp"><span style="color:#fa6e32;">#include </span><span style="color:#86b300;">&lt;BleKeyboard.h&gt;
</span><span style="color:#fa6e32;">#include </span><span style="color:#86b300;">&lt;Preferences.h&gt;
</span><span style="color:#fa6e32;">#include </span><span style="color:#86b300;">&quot;driver/rtc_io.h&quot;
</span><span style="color:#fa6e32;">#include </span><span style="color:#86b300;">&quot;esp_bt_device.h&quot;
</span><span style="color:#fa6e32;">#include </span><span style="color:#86b300;">&quot;esp_gap_ble_api.h&quot;
</span><span>
</span><span>BleKeyboard </span><span style="color:#f29718;">bleKeyboard</span><span>(</span><span style="color:#86b300;">&quot;Blue Button&quot;</span><span style="color:#61676ccc;">, </span><span style="color:#86b300;">&quot;Espressif&quot;</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">100</span><span>)</span><span style="color:#61676ccc;">;
</span><span>Preferences preferences</span><span style="color:#61676ccc;">;
</span><span>
</span><span style="color:#fa6e32;">const int</span><span> buttonPin </span><span style="color:#ed9366;">= </span><span style="color:#ff8f40;">5</span><span style="color:#61676ccc;">;
</span><span style="color:#fa6e32;">const unsigned long</span><span> awakeTime </span><span style="color:#ed9366;">= </span><span style="color:#ff8f40;">10000</span><span style="color:#61676ccc;">;      </span><span style="font-style:italic;color:#abb0b6;">// 10 seconds awake
</span><span style="color:#fa6e32;">const unsigned long</span><span> bleTimeout </span><span style="color:#ed9366;">= </span><span style="color:#ff8f40;">15000</span><span style="color:#61676ccc;">;     </span><span style="font-style:italic;color:#abb0b6;">// 15 seconds for BLE
</span><span style="color:#fa6e32;">bool</span><span> lastButtonState </span><span style="color:#ed9366;">=</span><span> HIGH</span><span style="color:#61676ccc;">;
</span><span style="color:#fa6e32;">unsigned long</span><span> startTime</span><span style="color:#61676ccc;">;
</span><span style="color:#fa6e32;">bool</span><span> alreadySentOnWake </span><span style="color:#ed9366;">= </span><span style="color:#ff8f40;">false</span><span style="color:#61676ccc;">;
</span><span>
</span><span style="color:#fa6e32;">void </span><span style="color:#f29718;">setCustomMacAddress</span><span>() {
</span><span>  preferences</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">begin</span><span>(</span><span style="color:#86b300;">&quot;ble-button&quot;</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">false</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  </span><span style="color:#fa6e32;">bool</span><span> macExists </span><span style="color:#ed9366;">=</span><span> preferences</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">getBool</span><span>(</span><span style="color:#86b300;">&quot;mac_set&quot;</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">false</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  </span><span style="color:#fa6e32;">if </span><span>(</span><span style="color:#ed9366;">!</span><span>macExists) {
</span><span>    Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;&gt;&gt;&gt; First start - generating new MAC...&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>    </span><span style="font-style:italic;color:#55b4d4;">uint8_t</span><span> newMac[</span><span style="color:#ff8f40;">6</span><span>]</span><span style="color:#61676ccc;">;
</span><span>    </span><span style="color:#f29718;">esp_fill_random</span><span>(newMac</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">6</span><span>)</span><span style="color:#61676ccc;">;
</span><span>    newMac[</span><span style="color:#ff8f40;">0</span><span>] </span><span style="color:#ed9366;">= </span><span>(newMac[</span><span style="color:#ff8f40;">0</span><span>] </span><span style="color:#ed9366;">&amp; </span><span style="color:#ff8f40;">0xFE</span><span>) </span><span style="color:#ed9366;">| </span><span style="color:#ff8f40;">0x02</span><span style="color:#61676ccc;">;
</span><span>    preferences</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">putBytes</span><span>(</span><span style="color:#86b300;">&quot;mac_addr&quot;</span><span style="color:#61676ccc;">,</span><span> newMac</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">6</span><span>)</span><span style="color:#61676ccc;">;
</span><span>    preferences</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">putBool</span><span>(</span><span style="color:#86b300;">&quot;mac_set&quot;</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">true</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  }
</span><span>  
</span><span>  </span><span style="font-style:italic;color:#55b4d4;">uint8_t</span><span> customMac[</span><span style="color:#ff8f40;">6</span><span>]</span><span style="color:#61676ccc;">;
</span><span>  preferences</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">getBytes</span><span>(</span><span style="color:#86b300;">&quot;mac_addr&quot;</span><span style="color:#61676ccc;">,</span><span> customMac</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">6</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  preferences</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">end</span><span>()</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  </span><span style="color:#f29718;">esp_base_mac_addr_set</span><span>(customMac)</span><span style="color:#61676ccc;">;
</span><span>}
</span><span>
</span><span style="color:#fa6e32;">void </span><span style="color:#f29718;">setupBLESecurity</span><span>() {
</span><span>  esp_ble_auth_req_t auth_req </span><span style="color:#ed9366;">=</span><span> ESP_LE_AUTH_REQ_SC_MITM_BOND</span><span style="color:#61676ccc;">;
</span><span>  esp_ble_io_cap_t iocap </span><span style="color:#ed9366;">=</span><span> ESP_IO_CAP_NONE</span><span style="color:#61676ccc;">;
</span><span>  </span><span style="font-style:italic;color:#55b4d4;">uint8_t</span><span> key_size </span><span style="color:#ed9366;">= </span><span style="color:#ff8f40;">16</span><span style="color:#61676ccc;">;
</span><span>  </span><span style="font-style:italic;color:#55b4d4;">uint8_t</span><span> init_key </span><span style="color:#ed9366;">=</span><span> ESP_BLE_ENC_KEY_MASK </span><span style="color:#ed9366;">|</span><span> ESP_BLE_ID_KEY_MASK</span><span style="color:#61676ccc;">;
</span><span>  </span><span style="font-style:italic;color:#55b4d4;">uint8_t</span><span> rsp_key </span><span style="color:#ed9366;">=</span><span> ESP_BLE_ENC_KEY_MASK </span><span style="color:#ed9366;">|</span><span> ESP_BLE_ID_KEY_MASK</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  </span><span style="color:#f29718;">esp_ble_gap_set_security_param</span><span>(ESP_BLE_SM_AUTHEN_REQ_MODE</span><span style="color:#61676ccc;">, </span><span style="color:#ed9366;">&amp;</span><span>auth_req</span><span style="color:#61676ccc;">, </span><span style="color:#fa6e32;">sizeof</span><span>(</span><span style="font-style:italic;color:#55b4d4;">uint8_t</span><span>))</span><span style="color:#61676ccc;">;
</span><span>  </span><span style="color:#f29718;">esp_ble_gap_set_security_param</span><span>(ESP_BLE_SM_IOCAP_MODE</span><span style="color:#61676ccc;">, </span><span style="color:#ed9366;">&amp;</span><span>iocap</span><span style="color:#61676ccc;">, </span><span style="color:#fa6e32;">sizeof</span><span>(</span><span style="font-style:italic;color:#55b4d4;">uint8_t</span><span>))</span><span style="color:#61676ccc;">;
</span><span>  </span><span style="color:#f29718;">esp_ble_gap_set_security_param</span><span>(ESP_BLE_SM_MAX_KEY_SIZE</span><span style="color:#61676ccc;">, </span><span style="color:#ed9366;">&amp;</span><span>key_size</span><span style="color:#61676ccc;">, </span><span style="color:#fa6e32;">sizeof</span><span>(</span><span style="font-style:italic;color:#55b4d4;">uint8_t</span><span>))</span><span style="color:#61676ccc;">;
</span><span>  </span><span style="color:#f29718;">esp_ble_gap_set_security_param</span><span>(ESP_BLE_SM_SET_INIT_KEY</span><span style="color:#61676ccc;">, </span><span style="color:#ed9366;">&amp;</span><span>init_key</span><span style="color:#61676ccc;">, </span><span style="color:#fa6e32;">sizeof</span><span>(</span><span style="font-style:italic;color:#55b4d4;">uint8_t</span><span>))</span><span style="color:#61676ccc;">;
</span><span>  </span><span style="color:#f29718;">esp_ble_gap_set_security_param</span><span>(ESP_BLE_SM_SET_RSP_KEY</span><span style="color:#61676ccc;">, </span><span style="color:#ed9366;">&amp;</span><span>rsp_key</span><span style="color:#61676ccc;">, </span><span style="color:#fa6e32;">sizeof</span><span>(</span><span style="font-style:italic;color:#55b4d4;">uint8_t</span><span>))</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;&gt;&gt;&gt; BLE Security activated&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>}
</span><span>
</span><span style="color:#fa6e32;">void </span><span style="color:#f29718;">goToSleep</span><span>() {
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&gt;&gt;&gt; Preparing Deep Sleep...&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  </span><span style="font-style:italic;color:#abb0b6;">// Wait until button is released
</span><span>  </span><span style="color:#fa6e32;">while</span><span>(</span><span style="color:#f29718;">digitalRead</span><span>(buttonPin) </span><span style="color:#ed9366;">==</span><span> LOW) {
</span><span>    </span><span style="color:#f29718;">delay</span><span>(</span><span style="color:#ff8f40;">100</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  }
</span><span>  </span><span style="color:#f29718;">delay</span><span>(</span><span style="color:#ff8f40;">500</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  </span><span style="font-style:italic;color:#abb0b6;">// End BLE cleanly
</span><span>  bleKeyboard</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">end</span><span>()</span><span style="color:#61676ccc;">;
</span><span>  </span><span style="color:#f29718;">delay</span><span>(</span><span style="color:#ff8f40;">500</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  </span><span style="color:#f29718;">btStop</span><span>()</span><span style="color:#61676ccc;">;
</span><span>  </span><span style="color:#f29718;">delay</span><span>(</span><span style="color:#ff8f40;">200</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  </span><span style="font-style:italic;color:#abb0b6;">// Configure RTC GPIO
</span><span>  </span><span style="color:#f29718;">rtc_gpio_init</span><span>((gpio_num_t)buttonPin)</span><span style="color:#61676ccc;">;
</span><span>  </span><span style="color:#f29718;">rtc_gpio_set_direction</span><span>((gpio_num_t)buttonPin</span><span style="color:#61676ccc;">,</span><span> RTC_GPIO_MODE_INPUT_ONLY)</span><span style="color:#61676ccc;">;
</span><span>  </span><span style="color:#f29718;">rtc_gpio_pullup_en</span><span>((gpio_num_t)buttonPin)</span><span style="color:#61676ccc;">;
</span><span>  </span><span style="color:#f29718;">rtc_gpio_pulldown_dis</span><span>((gpio_num_t)buttonPin)</span><span style="color:#61676ccc;">;
</span><span>  </span><span style="color:#f29718;">rtc_gpio_hold_en</span><span>((gpio_num_t)buttonPin)</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  </span><span style="color:#f29718;">esp_sleep_enable_ext0_wakeup</span><span>((gpio_num_t)buttonPin</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">0</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;&gt;&gt;&gt; Going to sleep...&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">flush</span><span>()</span><span style="color:#61676ccc;">;
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">end</span><span>()</span><span style="color:#61676ccc;">;
</span><span>  USBSerial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">end</span><span>()</span><span style="color:#61676ccc;">;
</span><span>  </span><span style="color:#f29718;">delay</span><span>(</span><span style="color:#ff8f40;">100</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  </span><span style="color:#f29718;">esp_deep_sleep_start</span><span>()</span><span style="color:#61676ccc;">;
</span><span>}
</span><span>
</span><span style="color:#fa6e32;">void </span><span style="color:#f29718;">setup</span><span>() {
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">begin</span><span>(</span><span style="color:#ff8f40;">115200</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  </span><span style="color:#f29718;">delay</span><span>(</span><span style="color:#ff8f40;">1000</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  </span><span style="color:#f29718;">rtc_gpio_deinit</span><span>((gpio_num_t)buttonPin)</span><span style="color:#61676ccc;">;
</span><span>  </span><span style="color:#f29718;">rtc_gpio_hold_dis</span><span>((gpio_num_t)buttonPin)</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  </span><span style="color:#f29718;">pinMode</span><span>(buttonPin</span><span style="color:#61676ccc;">,</span><span> INPUT_PULLUP)</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">=== WOKE UP! ===&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  </span><span style="color:#f29718;">setCustomMacAddress</span><span>()</span><span style="color:#61676ccc;">;
</span><span>  bleKeyboard</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">begin</span><span>()</span><span style="color:#61676ccc;">;
</span><span>  </span><span style="color:#f29718;">setupBLESecurity</span><span>()</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;BLE started - waiting for connection...&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  startTime </span><span style="color:#ed9366;">= </span><span style="color:#f29718;">millis</span><span>()</span><span style="color:#61676ccc;">;
</span><span>}
</span><span>
</span><span style="color:#fa6e32;">void </span><span style="color:#f29718;">loop</span><span>() {
</span><span>  </span><span style="font-style:italic;color:#abb0b6;">// Wait for BLE and then send
</span><span>  </span><span style="color:#fa6e32;">if</span><span>(</span><span style="color:#ed9366;">!</span><span>alreadySentOnWake) {
</span><span>    </span><span style="color:#fa6e32;">if</span><span>(bleKeyboard</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">isConnected</span><span>()) {
</span><span>      Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;&gt;&gt;&gt; BLE CONNECTED! Sending &#39;2&#39;...&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>      </span><span style="color:#f29718;">delay</span><span>(</span><span style="color:#ff8f40;">500</span><span>)</span><span style="color:#61676ccc;">;
</span><span>      bleKeyboard</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">print</span><span>(</span><span style="color:#86b300;">&quot;2&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>      </span><span style="color:#f29718;">delay</span><span>(</span><span style="color:#ff8f40;">300</span><span>)</span><span style="color:#61676ccc;">;
</span><span>      Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;&gt;&gt;&gt; &#39;2&#39; sent!&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>      alreadySentOnWake </span><span style="color:#ed9366;">= </span><span style="color:#ff8f40;">true</span><span style="color:#61676ccc;">;
</span><span>      startTime </span><span style="color:#ed9366;">= </span><span style="color:#f29718;">millis</span><span>()</span><span style="color:#61676ccc;">;  </span><span style="font-style:italic;color:#abb0b6;">// Reset timer
</span><span>    } </span><span style="color:#fa6e32;">else </span><span>{
</span><span>      </span><span style="color:#fa6e32;">if</span><span>(</span><span style="color:#f29718;">millis</span><span>() </span><span style="color:#ed9366;">-</span><span> startTime </span><span style="color:#ed9366;">&gt;</span><span> bleTimeout) {
</span><span>        Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;&gt;&gt;&gt; Timeout - sleeping without sending&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>        </span><span style="color:#f29718;">goToSleep</span><span>()</span><span style="color:#61676ccc;">;
</span><span>      }
</span><span>    }
</span><span>  }
</span><span>  
</span><span>  </span><span style="font-style:italic;color:#abb0b6;">// After sending: stay awake for 10 seconds
</span><span>  </span><span style="color:#fa6e32;">if</span><span>(alreadySentOnWake </span><span style="color:#ed9366;">&amp;&amp; </span><span style="color:#f29718;">millis</span><span>() </span><span style="color:#ed9366;">-</span><span> startTime </span><span style="color:#ed9366;">&gt;=</span><span> awakeTime) {
</span><span>    Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&gt;&gt;&gt; Timeout!&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>    </span><span style="color:#f29718;">goToSleep</span><span>()</span><span style="color:#61676ccc;">;
</span><span>  }
</span><span>  
</span><span>  </span><span style="font-style:italic;color:#abb0b6;">// Button during wake time
</span><span>  </span><span style="color:#fa6e32;">bool</span><span> buttonState </span><span style="color:#ed9366;">= </span><span style="color:#f29718;">digitalRead</span><span>(buttonPin)</span><span style="color:#61676ccc;">;
</span><span>  </span><span style="color:#fa6e32;">if</span><span>(buttonState </span><span style="color:#ed9366;">==</span><span> LOW </span><span style="color:#ed9366;">&amp;&amp;</span><span> lastButtonState </span><span style="color:#ed9366;">==</span><span> HIGH) {
</span><span>    </span><span style="color:#fa6e32;">if</span><span>(bleKeyboard</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">isConnected</span><span>()) {
</span><span>      Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;Button: Sending &#39;2&#39;&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>      bleKeyboard</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">print</span><span>(</span><span style="color:#86b300;">&quot;2&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>      </span><span style="color:#f29718;">delay</span><span>(</span><span style="color:#ff8f40;">300</span><span>)</span><span style="color:#61676ccc;">;
</span><span>      startTime </span><span style="color:#ed9366;">= </span><span style="color:#f29718;">millis</span><span>()</span><span style="color:#61676ccc;">;  </span><span style="font-style:italic;color:#abb0b6;">// Reset timer
</span><span>    }
</span><span>    </span><span style="color:#f29718;">delay</span><span>(</span><span style="color:#ff8f40;">50</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  }
</span><span>  lastButtonState </span><span style="color:#ed9366;">=</span><span> buttonState</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  </span><span style="color:#f29718;">delay</span><span>(</span><span style="color:#ff8f40;">10</span><span>)</span><span style="color:#61676ccc;">;
</span><span>}
</span></code></pre>
<h2 id="how-it-works-the-flow"><a class="zola-anchor" href="#how-it-works-the-flow" aria-label="Anchor link for: how-it-works-the-flow">How It Works: The Flow</a></h2>
<pre style="background-color:#fafafa;color:#61676c;"><code><span>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
</span><span>‚îÇ   DEEP SLEEP (~10¬µA)        ‚îÇ
</span><span>‚îÇ   CPU: OFF                  ‚îÇ
</span><span>‚îÇ   RAM: OFF                  ‚îÇ
</span><span>‚îÇ   BLE: OFF                  ‚îÇ
</span><span>‚îÇ   RTC: ON (waiting)         ‚îÇ
</span><span>‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</span><span>            ‚îÇ
</span><span>            ‚îÇ [Button pressed!]
</span><span>            ‚ñº
</span><span>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
</span><span>‚îÇ   WAKEUP (~300ms)           ‚îÇ
</span><span>‚îÇ   - CPU starts              ‚îÇ
</span><span>‚îÇ   - setup() runs            ‚îÇ
</span><span>‚îÇ   - Load MAC                ‚îÇ
</span><span>‚îÇ   - Start BLE               ‚îÇ
</span><span>‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</span><span>            ‚îÇ
</span><span>            ‚îÇ [BLE Connection]
</span><span>            ‚ñº
</span><span>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
</span><span>‚îÇ   CONNECTION (2-10 sec)     ‚îÇ
</span><span>‚îÇ   - Check bonding keys      ‚îÇ
</span><span>‚îÇ   - Secure connection       ‚îÇ
</span><span>‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</span><span>            ‚îÇ
</span><span>            ‚îÇ [isConnected()]
</span><span>            ‚ñº
</span><span>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
</span><span>‚îÇ   SEND KEY                  ‚îÇ
</span><span>‚îÇ   bleKeyboard.print(&quot;2&quot;)    ‚îÇ
</span><span>‚îÇ   Reset timer               ‚îÇ
</span><span>‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</span><span>            ‚îÇ
</span><span>            ‚îÇ [Wait 10 seconds]
</span><span>            ‚ñº
</span><span>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
</span><span>‚îÇ   BACK TO SLEEP             ‚îÇ
</span><span>‚îÇ   - Disconnect BLE          ‚îÇ
</span><span>‚îÇ   - RTC GPIO config         ‚îÇ
</span><span>‚îÇ   - esp_deep_sleep_start()  ‚îÇ
</span><span>‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</span></code></pre>
<h2 id="power-supply-with-cr123a-battery"><a class="zola-anchor" href="#power-supply-with-cr123a-battery" aria-label="Anchor link for: power-supply-with-cr123a-battery">Power Supply with CR123A Battery</a></h2>
<p>For mobile use, I decided on a <strong>CR123A battery</strong> - a brilliant solution for this project!</p>
<h3 id="why-cr123a"><a class="zola-anchor" href="#why-cr123a" aria-label="Anchor link for: why-cr123a">Why CR123A?</a></h3>
<ul>
<li><strong>High Capacity</strong>: 1,500-1,700mAh at 3V</li>
<li><strong>Compact Form Factor</strong>: Perfect for portable devices</li>
<li><strong>Long Shelf Life</strong>: Up to 10 years storage capability</li>
<li><strong>Stable Voltage</strong>: 3V fits perfectly with ESP32 (tolerates 2.3V-3.6V)</li>
<li><strong>Widely Available</strong>: In every electronics or photo shop</li>
</ul>
<h3 id="connection"><a class="zola-anchor" href="#connection" aria-label="Anchor link for: connection">Connection</a></h3>
<p>The ESP32-S3 can be powered directly with 3V:</p>
<ul>
<li>CR123A Battery: Plus (+) to 3V3 pin</li>
<li>CR123A Battery: Minus (-) to GND</li>
<li>Battery holder with switch recommended</li>
</ul>
<p><strong>Warning</strong>: When using USB, don't use the 3V3 pin, power via USB instead! When flashing, disconnect the battery or use a battery holder with a switch.</p>
<h2 id="power-consumption-the-numbers"><a class="zola-anchor" href="#power-consumption-the-numbers" aria-label="Anchor link for: power-consumption-the-numbers">Power Consumption: The Numbers</a></h2>
<table><thead><tr><th>State</th><th>Consumption</th><th>Duration</th></tr></thead><tbody>
<tr><td>Deep Sleep</td><td>~10-150¬µA</td><td>99% of the time</td></tr>
<tr><td>Wakeup + BLE</td><td>~80-120mA</td><td>2-10 seconds</td></tr>
<tr><td>Connected</td><td>~40-80mA</td><td>10 seconds</td></tr>
<tr><td>Sending</td><td>~100-150mA</td><td>&lt;1 second</td></tr>
</tbody></table>
<p><strong>With CR123A (1,600mAh)</strong>: Theoretically <strong>months to years</strong> of runtime, depending on button press frequency.</p>
<p>With 10 photo triggers per day:</p>
<ul>
<li>10 √ó 15 seconds awake = 150 seconds = 2.5 minutes</li>
<li>Consumption during wake time: ~80mA √ó 2.5min = ~3.3mAh per day</li>
<li>Deep Sleep remaining time: ~23.96h √ó 0.1mA = ~2.4mAh per day</li>
<li><strong>Total: ~5.7mAh per day</strong></li>
<li><strong>Runtime with CR123A: approx. 280 days (9+ months)!</strong></li>
</ul>
<p>With the CR123A battery, the button lasts almost a year - perfect for events!</p>
<h2 id="the-most-important-insights"><a class="zola-anchor" href="#the-most-important-insights" aria-label="Anchor link for: the-most-important-insights">The Most Important Insights</a></h2>
<h3 id="1-esp32-s3-is-different"><a class="zola-anchor" href="#1-esp32-s3-is-different" aria-label="Anchor link for: 1-esp32-s3-is-different">1. ESP32-S3 is Different</a></h3>
<p>The S3 requires explicit RTC GPIO configuration and terminating USBSerial. The "normal" ESP32 examples often don't work 1:1.</p>
<h3 id="2-deep-sleep-is-picky"><a class="zola-anchor" href="#2-deep-sleep-is-picky" aria-label="Anchor link for: 2-deep-sleep-is-picky">2. Deep Sleep is Picky</a></h3>
<p>The pin status when going to sleep is crucial. Always wait until the button is really released!</p>
<h3 id="3-ble-takes-time"><a class="zola-anchor" href="#3-ble-takes-time" aria-label="Anchor link for: 3-ble-takes-time">3. BLE Takes Time</a></h3>
<p>5-10 seconds for a connection is normal. Plan your timeout accordingly.</p>
<h3 id="4-bonding-is-worth-gold"><a class="zola-anchor" href="#4-bonding-is-worth-gold" aria-label="Anchor link for: 4-bonding-is-worth-gold">4. Bonding is Worth Gold</a></h3>
<p>With bonding, the device automatically reconnects after every wake-up. Without bonding, you have to pair every time.</p>
<h3 id="5-fixed-mac-happy-life"><a class="zola-anchor" href="#5-fixed-mac-happy-life" aria-label="Anchor link for: 5-fixed-mac-happy-life">5. Fixed MAC = Happy Life</a></h3>
<p>Without a fixed MAC, the computer sees a "new" device after every sleep. Storing the MAC in flash solves this problem elegantly.</p>
<h2 id="why-you-should-try-it-yourself"><a class="zola-anchor" href="#why-you-should-try-it-yourself" aria-label="Anchor link for: why-you-should-try-it-yourself">Why You Should Try It Yourself</a></h2>
<p>This project is perfect for learning:</p>
<ul>
<li><strong>Analog Hardware Meets Digital Logic</strong>: RTC GPIO, pullups, wakeup sources</li>
<li><strong>Power Management</strong>: Deep Sleep, optimizing power consumption</li>
<li><strong>Understanding BLE</strong>: Bonding, Security, Pairing</li>
<li><strong>Persistent Data</strong>: Preferences Library for flash memory</li>
<li><strong>Debugging</strong>: Serial Monitor, logic analysis, trial &amp; error</li>
</ul>
<p>And the best part: In the end you have a <strong>practical device</strong> that's actually useful!</p>
<h2 id="use-at-the-wheel-of-fortune"><a class="zola-anchor" href="#use-at-the-wheel-of-fortune" aria-label="Anchor link for: use-at-the-wheel-of-fortune">Use at the Wheel of Fortune</a></h2>
<p>The button is used at the tourism wheel of fortune: Visitors press the button, the key "2" is sent, the JavaScript on the Raspberry Pi triggers the photo function. Simple, reliable, no cables.</p>
<p>Visitors love it - especially the haptic component. A real button just feels better than "Press on the screen."</p>
<style>
   .containerimg   img {
        width: 200px;
       min-height: 200px;
        margin: 0 10px;
    }
</style>
<div  class="containerimg" style="
    text-align: center;
    display: flex;
    overflow: scroll;
    flex-direction: row;
    flex-wrap: nowrap;
    align-items: center;">
<img onclick="location.href='/posts/ble-button-deep-sleep-esp32/images/image00001.jpg'" src="/posts/ble-button-deep-sleep-esp32/images/image00001.jpg" alt="Blue Button">
<img onclick="location.href='/posts/ble-button-deep-sleep-esp32/images/image00002.jpg'" src="/posts/ble-button-deep-sleep-esp32/images/image00002.jpg" alt="Blue Button">
<img onclick="location.href='/posts/ble-button-deep-sleep-esp32/images/image00003.jpg'" src="/posts/ble-button-deep-sleep-esp32/images/image00003.jpg" alt="Blue Button">
<img onclick="location.href='/posts/ble-button-deep-sleep-esp32/images/image00004.jpg'" src="/posts/ble-button-deep-sleep-esp32/images/image00004.jpg" alt="Blue Button">
<img onclick="location.href='/posts/ble-button-deep-sleep-esp32/images/image00005.jpg'" src="/posts/ble-button-deep-sleep-esp32/images/image00005.jpg" alt="Blue Button">
</div>
<h2 id="outlook-what-else-would-be-possible"><a class="zola-anchor" href="#outlook-what-else-would-be-possible" aria-label="Anchor link for: outlook-what-else-would-be-possible">Outlook: What Else Would Be Possible</a></h2>
<p>With this setup you could do much more:</p>
<ul>
<li><strong>LED Feedback</strong>: Brief flashing on successful transmission</li>
<li><strong>Battery Monitoring</strong>: Measure battery voltage and warn</li>
<li><strong>Multi-Button</strong>: Different keys depending on press duration</li>
<li><strong>OTA Updates</strong>: Update firmware via BLE</li>
<li><strong>Motion Sensor</strong>: Additional wakeup via accelerometer</li>
</ul>
<h2 id="let-s-go"><a class="zola-anchor" href="#let-s-go" aria-label="Anchor link for: let-s-go">Let's Go!</a></h2>
<p>Do you feel like building your own BLE button? Perfect! Get yourself an ESP32-S3, a button and get started. The code is there, the explanations too.</p>
<p>And if you have questions or want to share your project - feel free to contact me!</p>
<p><strong>Happy Hacking!</strong></p>
<h2 id="shopping-list-everything-you-need"><a class="zola-anchor" href="#shopping-list-everything-you-need" aria-label="Anchor link for: shopping-list-everything-you-need">Shopping List - Everything You Need</a></h2>
<p>Here you'll find all the components you need for this project. The links go to Amazon and are affiliate links where you can order the parts directly:</p>
<h3 id="main-components"><a class="zola-anchor" href="#main-components" aria-label="Anchor link for: main-components">Main Components</a></h3>
<p><strong>ESP32-S3 Development Board</strong></p>
<ul>
<li><a href="https://amzn.eu/d/0T1NcSH/?tag=simeonstaneks-21">ESP32-S3 DevKit (2-pack)</a></li>
<li>Recommendation: The 2-pack is cheaper per board and you have backup for more projects</li>
</ul>
<p><strong>100mm Arcade Button</strong></p>
<ul>
<li><a href="https://amzn.eu/d/6UCftt8/?tag=simeonstaneks-21">LED Arcade Button 100mm (various colors)</a></li>
<li>Large, good-feeling button - perfect for events</li>
<li>Alternative: <a href="https://amzn.eu/d/j9O9DTu/?tag=simeonstaneks-21">Standard Arcade Button 60mm</a></li>
</ul>
<h3 id="power-supply"><a class="zola-anchor" href="#power-supply" aria-label="Anchor link for: power-supply">Power Supply</a></h3>
<p><strong>CR123A Batteries</strong></p>
<ul>
<li><a href="https://amzn.eu/d/ejrz6xh/?tag=simeonstaneks-21">Varta CR123A Lithium Batteries (2-pack)</a></li>
<li>High-quality brand batteries with long life</li>
</ul>
<p><strong>Battery Holder for CR123A</strong></p>
<ul>
<li><a href="https://amzn.eu/d/abbsqNz/?tag=simeonstaneks-21">CR123A Battery Holder with Connection Cable</a></li>
<li>With switch for easy on/off</li>
<li>Alternative: <a href="https://www.amazon.de/dp/B07VPVCKC4/?tag=simeonstaneks-21">CR123A Holder without Switch (cheaper)</a></li>
</ul>
<h3 id="optional-but-useful"><a class="zola-anchor" href="#optional-but-useful" aria-label="Anchor link for: optional-but-useful">Optional but Useful</a></h3>
<p><strong>USB-C Cable for Flashing</strong></p>
<ul>
<li><a href="https://amzn.eu/d/j8toLfn/?tag=simeonstaneks-21">USB-C Data Cable</a></li>
<li>Important: Use data cable, not just charging cable!</li>
</ul>
<p><strong>Jumper Cables</strong></p>
<ul>
<li><a href="https://www.amazon.de/dp/B07K8PVKBP/?tag=simeonstaneks-21">Dupont Jumper Cable Set</a></li>
<li>For easy connecting during prototyping</li>
</ul>
<h3 id="estimated-total-cost"><a class="zola-anchor" href="#estimated-total-cost" aria-label="Anchor link for: estimated-total-cost">Estimated Total Cost</a></h3>
<ul>
<li><strong>Minimal Setup</strong>: ~$25-30 (ESP32, button, battery + holder)</li>
</ul>
<p>Have fun building! üõ†Ô∏è</p>
<p><em>Hardware Used:</em></p>
<ul>
<li>ESP32-S3 Dev Module</li>
<li>100mm Arcade Button</li>
<li>CR123A Battery + Battery Holder</li>
<li>Optional: Enclosure</li>
</ul>
<p><em>Required Libraries:</em></p>
<ul>
<li><a href="https://github.com/T-vK/ESP32-BLE-Keyboard">ESP32-BLE-Keyboard</a></li>
<li>Preferences (ESP32 Core)</li>
<li>driver/rtc_io.h (ESP32 Core)</li>
</ul>
<p><em>Board Manager for ESP32:</em></p>
<ul>
<li>Version 2.0.17 !!!</li>
</ul>
<p><em>Power Supply:</em></p>
<ul>
<li>For Development/Flashing: USB-C Cable</li>
<li>For Production Use: CR123A Battery with Battery Holder (see shopping list)</li>
</ul>
<p>Here is the complete code for the ESP32-C3 BLE button with Deep Sleep:</p>
<ul>
<li>A fork of ESP32-BLE-Keyboard by T-vK was used, which is compatible with the ESP32-C3:
<a href="https://github.com/lewisxhe/ESP32-BLE-Keyboard-fork">Fork by lewisxhe</a></li>
<li>Additionally, the NimBLEDevice.h library is needed for the security settings.</li>
</ul>
<pre data-lang="cpp" style="background-color:#fafafa;color:#61676c;" class="language-cpp "><code class="language-cpp" data-lang="cpp"><span style="color:#fa6e32;">#include </span><span style="color:#86b300;">&lt;BleKeyboard.h&gt;
</span><span style="color:#fa6e32;">#include </span><span style="color:#86b300;">&lt;Preferences.h&gt;
</span><span style="color:#fa6e32;">#include </span><span style="color:#86b300;">&quot;esp_sleep.h&quot;
</span><span style="color:#fa6e32;">#include </span><span style="color:#86b300;">&quot;driver/gpio.h&quot;
</span><span style="color:#fa6e32;">#include </span><span style="color:#86b300;">&quot;esp_system.h&quot;
</span><span style="color:#fa6e32;">#include </span><span style="color:#86b300;">&lt;NimBLEDevice.h&gt;
</span><span>
</span><span>BleKeyboard </span><span style="color:#f29718;">bleKeyboard</span><span>(</span><span style="color:#86b300;">&quot;Blue Button&quot;</span><span style="color:#61676ccc;">, </span><span style="color:#86b300;">&quot;Espressif&quot;</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">100</span><span>)</span><span style="color:#61676ccc;">;
</span><span>Preferences preferences</span><span style="color:#61676ccc;">;
</span><span>
</span><span style="color:#fa6e32;">const int</span><span> buttonPin </span><span style="color:#ed9366;">= </span><span style="color:#ff8f40;">3</span><span style="color:#61676ccc;">;  </span><span style="font-style:italic;color:#abb0b6;">// ESP32-C3 GPIO3
</span><span style="color:#fa6e32;">const unsigned long</span><span> awakeTime </span><span style="color:#ed9366;">= </span><span style="color:#ff8f40;">10000</span><span style="color:#61676ccc;">;      </span><span style="font-style:italic;color:#abb0b6;">// 10 seconds awake
</span><span style="color:#fa6e32;">const unsigned long</span><span> bleTimeout </span><span style="color:#ed9366;">= </span><span style="color:#ff8f40;">15000</span><span style="color:#61676ccc;">;     </span><span style="font-style:italic;color:#abb0b6;">// 15 seconds for BLE
</span><span style="color:#fa6e32;">bool</span><span> lastButtonState </span><span style="color:#ed9366;">=</span><span> HIGH</span><span style="color:#61676ccc;">;
</span><span style="color:#fa6e32;">unsigned long</span><span> startTime</span><span style="color:#61676ccc;">;
</span><span style="color:#fa6e32;">bool</span><span> alreadySentOnWake </span><span style="color:#ed9366;">= </span><span style="color:#ff8f40;">false</span><span style="color:#61676ccc;">;
</span><span>
</span><span style="color:#fa6e32;">void </span><span style="color:#f29718;">goToSleep</span><span>() {
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&gt;&gt;&gt; Preparing Deep Sleep...&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  </span><span style="font-style:italic;color:#abb0b6;">// Wait until button is released
</span><span>  </span><span style="color:#fa6e32;">while</span><span>(</span><span style="color:#f29718;">digitalRead</span><span>(buttonPin) </span><span style="color:#ed9366;">==</span><span> LOW) {
</span><span>    </span><span style="color:#f29718;">delay</span><span>(</span><span style="color:#ff8f40;">100</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  }
</span><span>  </span><span style="color:#f29718;">delay</span><span>(</span><span style="color:#ff8f40;">500</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  </span><span style="font-style:italic;color:#abb0b6;">// Cleanly terminate BLE
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;&gt;&gt;&gt; Ending BLE...&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  bleKeyboard</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">end</span><span>()</span><span style="color:#61676ccc;">;
</span><span>  </span><span style="color:#f29718;">delay</span><span>(</span><span style="color:#ff8f40;">500</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&gt;&gt;&gt; Configuring Deep Sleep GPIO Wakeup...&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  </span><span style="font-style:italic;color:#abb0b6;">// Create GPIO pin mask
</span><span>  </span><span style="font-style:italic;color:#55b4d4;">uint64_t</span><span> gpio_pin_mask </span><span style="color:#ed9366;">= </span><span>(</span><span style="color:#ff8f40;">1</span><span style="color:#fa6e32;">ULL </span><span style="color:#ed9366;">&lt;&lt;</span><span> buttonPin)</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  </span><span style="font-style:italic;color:#abb0b6;">// Enable Deep Sleep GPIO Wakeup
</span><span>  esp_err_t err </span><span style="color:#ed9366;">= </span><span style="color:#f29718;">esp_deep_sleep_enable_gpio_wakeup</span><span>(
</span><span>    gpio_pin_mask</span><span style="color:#61676ccc;">, 
</span><span>    ESP_GPIO_WAKEUP_GPIO_LOW
</span><span>  )</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  </span><span style="color:#fa6e32;">if </span><span>(err </span><span style="color:#ed9366;">==</span><span> ESP_OK) {
</span><span>    Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">printf</span><span>(</span><span style="color:#86b300;">&quot;OK - Deep Sleep Wakeup for GPIO </span><span style="color:#ff8f40;">%d</span><span style="color:#86b300;"> enabled</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span style="color:#61676ccc;">,</span><span> buttonPin)</span><span style="color:#61676ccc;">;
</span><span>  } </span><span style="color:#fa6e32;">else </span><span>{
</span><span>    Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">printf</span><span>(</span><span style="color:#86b300;">&quot;ERROR in GPIO Wakeup Config: </span><span style="color:#ff8f40;">%d</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span style="color:#61676ccc;">,</span><span> err)</span><span style="color:#61676ccc;">;
</span><span>  }
</span><span>  
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">printf</span><span>(</span><span style="color:#86b300;">&quot;GPIO </span><span style="color:#ff8f40;">%d</span><span style="color:#86b300;"> status before sleep: </span><span style="color:#ff8f40;">%d</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span style="color:#61676ccc;">,</span><span> buttonPin</span><span style="color:#61676ccc;">, </span><span style="color:#f29718;">digitalRead</span><span>(buttonPin))</span><span style="color:#61676ccc;">;
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&gt;&gt;&gt; Going to sleep... (Press button to wake up)&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">flush</span><span>()</span><span style="color:#61676ccc;">;
</span><span>  </span><span style="color:#f29718;">delay</span><span>(</span><span style="color:#ff8f40;">200</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  </span><span style="color:#f29718;">esp_deep_sleep_start</span><span>()</span><span style="color:#61676ccc;">;
</span><span>}
</span><span>
</span><span style="color:#fa6e32;">void </span><span style="color:#f29718;">setup</span><span>() {
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">begin</span><span>(</span><span style="color:#ff8f40;">115200</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  </span><span style="color:#f29718;">delay</span><span>(</span><span style="color:#ff8f40;">2000</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  </span><span style="color:#f29718;">pinMode</span><span>(buttonPin</span><span style="color:#61676ccc;">,</span><span> INPUT_PULLUP)</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">=============================&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;=== ESP32-C3 WOKE UP! ===&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;=============================&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  esp_sleep_wakeup_cause_t wakeup_reason </span><span style="color:#ed9366;">= </span><span style="color:#f29718;">esp_sleep_get_wakeup_cause</span><span>()</span><span style="color:#61676ccc;">;
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">printf</span><span>(</span><span style="color:#86b300;">&quot;Wakeup Cause: </span><span style="color:#ff8f40;">%d</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span style="color:#61676ccc;">,</span><span> wakeup_reason)</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  </span><span style="color:#fa6e32;">switch</span><span>(wakeup_reason) {
</span><span>    </span><span style="color:#fa6e32;">case</span><span> ESP_SLEEP_WAKEUP_GPIO</span><span style="color:#61676ccc;">:
</span><span>      Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;&gt;&gt;&gt; SUCCESS: Wakeup by GPIO!&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>      </span><span style="color:#fa6e32;">break</span><span style="color:#61676ccc;">;
</span><span>    </span><span style="color:#fa6e32;">case</span><span> ESP_SLEEP_WAKEUP_TIMER</span><span style="color:#61676ccc;">:
</span><span>      Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;&gt;&gt;&gt; Wakeup by Timer!&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>      </span><span style="color:#fa6e32;">break</span><span style="color:#61676ccc;">;
</span><span>    </span><span style="color:#fa6e32;">case</span><span> ESP_SLEEP_WAKEUP_UNDEFINED</span><span style="color:#61676ccc;">:
</span><span>    </span><span style="color:#fa6e32;">default</span><span style="color:#61676ccc;">:
</span><span>      Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;&gt;&gt;&gt; Power-On / Reset / Upload&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>      </span><span style="color:#fa6e32;">break</span><span style="color:#61676ccc;">;
</span><span>  }
</span><span>  
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">printf</span><span>(</span><span style="color:#86b300;">&quot;GPIO </span><span style="color:#ff8f40;">%d</span><span style="color:#86b300;"> status: </span><span style="color:#ff8f40;">%d</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span style="color:#61676ccc;">,</span><span> buttonPin</span><span style="color:#61676ccc;">, </span><span style="color:#f29718;">digitalRead</span><span>(buttonPin))</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  </span><span style="font-style:italic;color:#abb0b6;">// FIRST start BleKeyboard
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&gt;&gt;&gt; Starting BLE Keyboard...&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  bleKeyboard</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">begin</span><span>()</span><span style="color:#61676ccc;">;
</span><span>  </span><span style="color:#f29718;">delay</span><span>(</span><span style="color:#ff8f40;">1000</span><span>)</span><span style="color:#61676ccc;">;  </span><span style="font-style:italic;color:#abb0b6;">// Important: Wait until BLE is fully initialized!
</span><span>  
</span><span>  </span><span style="font-style:italic;color:#abb0b6;">// THEN configure Security
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;&gt;&gt;&gt; Configuring Bonding...&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  NimBLEDevice</span><span style="color:#ed9366;">::</span><span style="color:#f29718;">setSecurityAuth</span><span>(BLE_SM_PAIR_AUTHREQ_BOND)</span><span style="color:#61676ccc;">;
</span><span>  NimBLEDevice</span><span style="color:#ed9366;">::</span><span style="color:#f29718;">setSecurityIOCap</span><span>(BLE_HS_IO_NO_INPUT_OUTPUT)</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;OK - Just Works Bonding enabled!&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;==============================&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;  PAIRING: No PIN required!&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;==============================&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">PAIRING INSTRUCTIONS:&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;  1. Open Bluetooth settings&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;  2. Search for &#39;Blue Button&#39;&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;  3. Tap &#39;Connect&#39;&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;  4. Confirm pairing (no PIN!)&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;  5. Connection will be saved!&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;  6. On next wake-up: Auto-Reconnect!</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;BLE started - waiting for connection...&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  startTime </span><span style="color:#ed9366;">= </span><span style="color:#f29718;">millis</span><span>()</span><span style="color:#61676ccc;">;
</span><span>  alreadySentOnWake </span><span style="color:#ed9366;">= </span><span style="color:#ff8f40;">false</span><span style="color:#61676ccc;">;
</span><span>}
</span><span>
</span><span style="color:#fa6e32;">void </span><span style="color:#f29718;">loop</span><span>() {
</span><span>  </span><span style="font-style:italic;color:#abb0b6;">// Wait for BLE and then send
</span><span>  </span><span style="color:#fa6e32;">if</span><span>(</span><span style="color:#ed9366;">!</span><span>alreadySentOnWake) {
</span><span>    </span><span style="color:#fa6e32;">if</span><span>(bleKeyboard</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">isConnected</span><span>()) {
</span><span>      Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&gt;&gt;&gt; BLE CONNECTED!&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>      Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;&gt;&gt;&gt; Sending &#39;2&#39;...&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>      </span><span style="color:#f29718;">delay</span><span>(</span><span style="color:#ff8f40;">500</span><span>)</span><span style="color:#61676ccc;">;
</span><span>      bleKeyboard</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">print</span><span>(</span><span style="color:#86b300;">&quot;2&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>      </span><span style="color:#f29718;">delay</span><span>(</span><span style="color:#ff8f40;">300</span><span>)</span><span style="color:#61676ccc;">;
</span><span>      Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;&gt;&gt;&gt; &#39;2&#39; sent successfully!&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>      alreadySentOnWake </span><span style="color:#ed9366;">= </span><span style="color:#ff8f40;">true</span><span style="color:#61676ccc;">;
</span><span>      startTime </span><span style="color:#ed9366;">= </span><span style="color:#f29718;">millis</span><span>()</span><span style="color:#61676ccc;">;
</span><span>    } </span><span style="color:#fa6e32;">else </span><span>{
</span><span>      </span><span style="font-style:italic;color:#abb0b6;">// Show waiting time
</span><span>      </span><span style="color:#fa6e32;">unsigned long</span><span> elapsed </span><span style="color:#ed9366;">= </span><span style="color:#f29718;">millis</span><span>() </span><span style="color:#ed9366;">-</span><span> startTime</span><span style="color:#61676ccc;">;
</span><span>      </span><span style="color:#fa6e32;">if</span><span>(elapsed </span><span style="color:#ed9366;">% </span><span style="color:#ff8f40;">2000 </span><span style="color:#ed9366;">&lt; </span><span style="color:#ff8f40;">50</span><span>) {  </span><span style="font-style:italic;color:#abb0b6;">// Every 2 seconds
</span><span>        Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">printf</span><span>(</span><span style="color:#86b300;">&quot;Waiting for BLE... (</span><span style="color:#ff8f40;">%lu</span><span style="color:#86b300;">/</span><span style="color:#ff8f40;">%lu</span><span style="color:#86b300;"> ms)</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span style="color:#61676ccc;">,</span><span> elapsed</span><span style="color:#61676ccc;">,</span><span> bleTimeout)</span><span style="color:#61676ccc;">;
</span><span>      }
</span><span>      
</span><span>      </span><span style="color:#fa6e32;">if</span><span>(elapsed </span><span style="color:#ed9366;">&gt;</span><span> bleTimeout) {
</span><span>        Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&gt;&gt;&gt; BLE Timeout - going to sleep&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>        Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;Tip: Check pairing in Bluetooth settings!&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>        </span><span style="color:#f29718;">goToSleep</span><span>()</span><span style="color:#61676ccc;">;
</span><span>      }
</span><span>    }
</span><span>  }
</span><span>  
</span><span>  </span><span style="font-style:italic;color:#abb0b6;">// After sending: stay awake for 10 seconds
</span><span>  </span><span style="color:#fa6e32;">if</span><span>(alreadySentOnWake </span><span style="color:#ed9366;">&amp;&amp; </span><span style="color:#f29718;">millis</span><span>() </span><span style="color:#ed9366;">-</span><span> startTime </span><span style="color:#ed9366;">&gt;=</span><span> awakeTime) {
</span><span>    Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&gt;&gt;&gt; Awake timeout reached!&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>    </span><span style="color:#f29718;">goToSleep</span><span>()</span><span style="color:#61676ccc;">;
</span><span>  }
</span><span>  
</span><span>  </span><span style="font-style:italic;color:#abb0b6;">// Button during awake time
</span><span>  </span><span style="color:#fa6e32;">bool</span><span> buttonState </span><span style="color:#ed9366;">= </span><span style="color:#f29718;">digitalRead</span><span>(buttonPin)</span><span style="color:#61676ccc;">;
</span><span>  </span><span style="color:#fa6e32;">if</span><span>(buttonState </span><span style="color:#ed9366;">==</span><span> LOW </span><span style="color:#ed9366;">&amp;&amp;</span><span> lastButtonState </span><span style="color:#ed9366;">==</span><span> HIGH) {
</span><span>    </span><span style="color:#fa6e32;">if</span><span>(bleKeyboard</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">isConnected</span><span>()) {
</span><span>      Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&gt;&gt;&gt; Button pressed - Sending &#39;2&#39;&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>      bleKeyboard</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">print</span><span>(</span><span style="color:#86b300;">&quot;2&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>      </span><span style="color:#f29718;">delay</span><span>(</span><span style="color:#ff8f40;">300</span><span>)</span><span style="color:#61676ccc;">;
</span><span>      Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;&gt;&gt;&gt; &#39;2&#39; sent!&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>      startTime </span><span style="color:#ed9366;">= </span><span style="color:#f29718;">millis</span><span>()</span><span style="color:#61676ccc;">;  </span><span style="font-style:italic;color:#abb0b6;">// Reset timer
</span><span>    } </span><span style="color:#fa6e32;">else </span><span>{
</span><span>      Serial</span><span style="color:#ed9366;">.</span><span style="color:#f29718;">println</span><span>(</span><span style="color:#86b300;">&quot;</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&gt;&gt;&gt; Button pressed - but not connected!&quot;</span><span>)</span><span style="color:#61676ccc;">;
</span><span>    }
</span><span>    </span><span style="color:#f29718;">delay</span><span>(</span><span style="color:#ff8f40;">50</span><span>)</span><span style="color:#61676ccc;">;
</span><span>  }
</span><span>  lastButtonState </span><span style="color:#ed9366;">=</span><span> buttonState</span><span style="color:#61676ccc;">;
</span><span>  
</span><span>  </span><span style="color:#f29718;">delay</span><span>(</span><span style="color:#ff8f40;">10</span><span>)</span><span style="color:#61676ccc;">;
</span><span>}
</span></code></pre>

        </section>
    </article>
    <hr>
    <br>
    <div class="meta">
        
            <span class="date-label-posted">:: Posted on </span><time>2025-11-19</time>
        

        

        

        
        
                <span class="tags-label"> :: Tags:</span>
                <span class="tags">
                        <a href="https://simeon.staneks.de/tags/esp32s3/" class="post-tag">ESP32S3</a>, 
                    
                        <a href="https://simeon.staneks.de/tags/ble/" class="post-tag">BLE</a>, 
                    
                        <a href="https://simeon.staneks.de/tags/deep-sleep/" class="post-tag">Deep Sleep</a>, 
                    
                        <a href="https://simeon.staneks.de/tags/hardware/" class="post-tag">Hardware</a>, 
                    
                        <a href="https://simeon.staneks.de/tags/iot/" class="post-tag">IoT</a>, 
                    
                        <a href="https://simeon.staneks.de/tags/tourismuspastoral/" class="post-tag">Tourismuspastoral</a>, 
                    
                        <a href="https://simeon.staneks.de/tags/esp32c3/" class="post-tag">ESP32C3</a>
                    
                </span>
        

        
       
                
     

            
                
                :: <a href="https:&#x2F;&#x2F;github.com&#x2F;SimeonLukas&#x2F;Blog&#x2F;tree&#x2F;main&#x2F;content&#x2F;posts&#x2F;ble-button-deep-sleep-esp32&#x2F;index.en.md" target="_blank" rel="noopener noreferrer"> Source Code</a>
            

        

    </div>

    
    
        
    

    
        
        
        
        
            
        
            
        
            
        
            
                
            
        

        
        

        <div class="video-link" style="margin-top: 2em; padding: 1em; border-top: 1px solid #ccc;display: flex; flex-direction: column; align-items: center;">
            
                <video style="width: auto; max-width: 320px;" controls>
                    <source src="https:&#x2F;&#x2F;simeon.staneks.de&#x2F;en&#x2F;posts&#x2F;ble-button-deep-sleep-esp32&#x2F;video&#x2F;ble-button-deep-sleep-esp32-en.mp4" onerror="this.parentElement.parentElement.style.display='none';" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            
        </div>
    
</main>



        
            
        

        
        <br>
        <hr>
        <div class="giscus" >
        <script src="https://giscus.app/client.js"
        data-repo="SimeonLukas/Blog"
        data-repo-id="R_kgDONSw5PA"
        data-category="Announcements"
        data-category-id="DIC_kwDONSw5PM4CkoL8"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="https:&#x2F;&#x2F;simeon.staneks.de/css/giscus.css"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>


    </div>
    <br>
    <br>
    <br>
        

    </div>
</body>

</html>
